<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Models • GLMMadaptive</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Custom Models">
<meta property="og:description" content="GLMMadaptive">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GLMMadaptive</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7-12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Custom_Models.html">Custom Models</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/GLMMadaptive_basics.html">GLMMadaptive Basics</a>
    </li>
    <li>
      <a href="../articles/Goodness_of_Fit.html">Goodness of Fit for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Methods_MixMod.html">Methods for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Multiple_Comparisons.html">Multiple Comparisons for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Optimization.html">Optimization and Numerical Integration in GLMMadaptive</a>
    </li>
    <li>
      <a href="../articles/Ordinal_Mixed_Models.html">Mixed Models for Ordinal Data</a>
    </li>
    <li>
      <a href="../articles/ZeroInflated_and_TwoPart_Models.html">Zero-Inflated and Two-Part Mixed Effects Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/GLMMadaptive/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Custom_Models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Custom Models</h1>
                        <h4 class="author">Dimitris Rizopoulos</h4>
            
            <h4 class="date">2020-09-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/GLMMadaptive/blob/master/vignettes/Custom_Models.Rmd"><code>vignettes/Custom_Models.Rmd</code></a></small>
      <div class="hidden name"><code>Custom_Models.Rmd</code></div>

    </div>

    
    
<div id="user-defined-family-objects" class="section level1">
<h1 class="hasAnchor">
<a href="#user-defined-family-objects" class="anchor"></a>User-Defined Family Objects</h1>
<p>In addition to the standard family objects in R, function <code><a href="../reference/mixed_model.html">mixed_model()</a></code> also allows for user-specified family objects to be given in its <code>family</code> argument. The minimum requirements are that user-specified family object is of class <code>"family"</code> and is a list with the following components:</p>
<ul>
<li><p><code>family</code>: a character string giving the name of the family.</p></li>
<li><p><code>link</code>: a character string giving the name of the link function.</p></li>
<li><p><code>linkfun</code>: a function that transforms the mean of the distribution of the outcome to the linear predictor scale.</p></li>
<li><p><code>linkinv</code>: a function that is the inverse of the <code>linkfun</code> defined above.</p></li>
<li><p><code>log_dens</code>: a function that returns the log of the probability density function or the log of the probability mass function of the distribution of the outcome given the random effects. This function should have exactly five arguments named, <code>y</code> the repeated measurements outcome, <code>eta</code> denoting the linear predictor (fixed + random effects), <code>mu_fun</code> the function to calculate the mean from the linear predictor (i.e., the <code>linkinv</code> function), <code>phis</code> a vector of possible extra dispersion/scale parameters, and <code>eta_zi</code> the linear predictor (fixed + random effects) for the logistic regression for the extra zeros; relevant in the cases of zero-inflated and two-part models. <strong>Even if <code>phis</code> and <code>eta_zi</code> may not be required, it should always appear as arguments of <code>log_dens</code></strong>. Moreover, when the extra parameters <code>phis</code> are required, they should be appropriately transformed in order for the optimization of the log-likelihood to be unconstrained with regard to these parameters. Finally, <code>log_dens</code> should be fully vectorized with respect to <code>eta</code> and <code>eta_zi</code>. That is, for a numeric vector <code>y</code> and a numeric matrix <code>eta</code>, it should return a matrix with the log density evaluated at each column of <code>eta</code>, and likewise for <code>eta_zi</code>.</p></li>
</ul>
<p>For the internal calculations the derivative of <code>log_dens</code> with respect to the linear predictor <code>eta</code> and extra parameters <code>phis</code> (when present) is also required. If it is not given, then it is approximated numerically using a central difference approximation. However, it greatly facilitates stability and speed if the user also specifies these functions. If the user specifies these functions, they should have the names <code>score_eta_fun</code> and <code>score_phis_fun</code>, respectively, and both of them have three arguments named <code>y</code> the numeric vector of the repeated measurements outcome, <code>mu</code> the numeric vector or matrix of the mean of the outcome and <code>phis</code> a numeric vector of the extra parameters.</p>
<div id="negative-binomial-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#negative-binomial-mixed-effects-model" class="anchor"></a>Negative Binomial Mixed Effects Model</h2>
<p>We first illustrate the use of a custom-made family object in the case of a negative binomial repeated measurements outcome. We should note however that a family object <code><a href="../reference/negative.binomial.html">negative.binomial()</a></code> is already defined in the package and users could invoke this instead - for more info see the relative online help page for <code><a href="../reference/negative.binomial.html">negative.binomial()</a></code>. We start by simulating some data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">101</span>)
<span class="kw">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(f1 = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">3</span>), f2 = <span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], g = <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, rep = <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,
                  KEEP.OUT.ATTRS = <span class="fl">FALSE</span>)
<span class="kw">mu</span> <span class="op">&lt;-</span> <span class="fl">5</span><span class="op">*</span>(<span class="op">-</span><span class="fl">4</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="kw">dd</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw">f1</span>) <span class="op">+</span> <span class="fl">4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">f2</span>)))
<span class="kw">dd</span><span class="op">$</span><span class="kw">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html">rnbinom</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">dd</span>), mu = <span class="kw">mu</span>, size = <span class="fl">0.5</span>)
</pre></div>
<p>Next we define a new family object for negative binomial data</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">my_negBinom</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">link</span> = <span class="st">"log"</span>) {
    <span class="kw">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/make.link.html">make.link</a></span>(<span class="kw">link</span>)
    <span class="kw">log_dens</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">eta</span>, <span class="kw">mu_fun</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the log density function</span>
        <span class="kw">phis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>) <span class="co"># unconstrained optimization of 'phis'</span>
        <span class="kw">mu</span> <span class="op">&lt;-</span> <span class="fu">mu_fun</span>(<span class="kw">eta</span>)
        <span class="kw">log_mu_phis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">mu</span> <span class="op">+</span> <span class="kw">phis</span>)
        <span class="kw">comp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">y</span> <span class="op">+</span> <span class="kw">phis</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">phis</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">y</span> <span class="op">+</span> <span class="fl">1</span>)
        <span class="kw">comp2</span> <span class="op">&lt;-</span> <span class="kw">phis</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">phis</span>) <span class="op">-</span> <span class="kw">phis</span> <span class="op">*</span> <span class="kw">log_mu_phis</span>
        <span class="kw">comp3</span> <span class="op">&lt;-</span> <span class="kw">y</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">mu</span>) <span class="op">-</span> <span class="kw">y</span> <span class="op">*</span> <span class="kw">log_mu_phis</span>
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="kw">comp1</span> <span class="op">+</span> <span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>
        <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="kw">out</span>, <span class="st">"mu_y"</span>) <span class="op">&lt;-</span> <span class="kw">mu</span>
        <span class="kw">out</span>
    }
    <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(family = <span class="st">"user Neg Binom"</span>, link = <span class="kw">stats</span><span class="op">$</span><span class="kw">name</span>, linkfun = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkfun</span>,
                   linkinv = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkinv</span>, log_dens = <span class="kw">log_dens</span>),
              class = <span class="st">"family"</span>)
}
</pre></div>
<p>And we fit the model</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
    <span class="kw">fm1</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(fixed = <span class="kw">y</span> <span class="op">~</span> <span class="kw">f1</span> <span class="op">*</span> <span class="kw">f2</span>, random = <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">g</span>, data = <span class="kw">dd</span>, 
                        family = <span class="fu">my_negBinom</span>(), n_phis = <span class="fl">1</span>, 
                        initial_values = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"betas"</span> = <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>()))
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    5.52    0.02    5.53</span>

<span class="kw">fm1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ f1 * f2, random = ~1 | g, data = dd, </span>
<span class="co">#&gt;     family = my_negBinom(), n_phis = 1, initial_values = list(betas = poisson()))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: user Neg Binom</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                 StdDev</span>
<span class="co">#&gt; (Intercept) 0.07476986</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt; (Intercept)         f12         f13         f2B     f12:f2B     f13:f2B </span>
<span class="co">#&gt;   1.6361833   0.6031425   1.0137677   1.5385349  -0.4378977  -0.5835306 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  -0.6477285 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -9994.062</span>
</pre></div>
<p>In the call to <code><a href="../reference/mixed_model.html">mixed_model()</a></code> we specify the argument <code>n_phis</code> which lets the function know how many extra parameters does the distribution of the outcome have. In addition, we also specify that better quality initial values for the fixed effects <code>betas</code> can be obtained by fitting a Poisson regression model to the repeated measurements outcome (ignoring the correlations) with the same design matrix as the fixed-effects design matrix. For the unique elements of the random effects covariance matrix and for the extra parameters <code>phis</code> the default initial values are used.</p>
<p>In the output, the reported phi parameters is on the log scale, because in the definition of <code>log_dens</code> we specified that <code>phis &lt;- exp(phis)</code>.</p>
<p>As mentioned above, the internal computations are facilitated if the user also specifies the derivatives of the log density with respect to the linear predictor <code>eta</code> and the extra parameters <code>phis</code>. Hence, in the following we define a new negative binomial family object with these functions also defined:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">my_negBinom2</span> <span class="op">&lt;-</span> <span class="fu">function</span> () {
    <span class="kw">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/make.link.html">make.link</a></span>(link = <span class="st">"log"</span>)
    <span class="kw">log_dens</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">eta</span>, <span class="kw">mu_fun</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the log density function</span>
        <span class="kw">phis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">mu</span> <span class="op">&lt;-</span> <span class="fu">mu_fun</span>(<span class="kw">eta</span>)
        <span class="kw">log_mu_phis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">mu</span> <span class="op">+</span> <span class="kw">phis</span>)
        <span class="kw">comp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">y</span> <span class="op">+</span> <span class="kw">phis</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">phis</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">y</span> <span class="op">+</span> <span class="fl">1</span>)
        <span class="kw">comp2</span> <span class="op">&lt;-</span> <span class="kw">phis</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">phis</span>) <span class="op">-</span> <span class="kw">phis</span> <span class="op">*</span> <span class="kw">log_mu_phis</span>
        <span class="kw">comp3</span> <span class="op">&lt;-</span> <span class="kw">y</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">mu</span>) <span class="op">-</span> <span class="kw">y</span> <span class="op">*</span> <span class="kw">log_mu_phis</span>
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="kw">comp1</span> <span class="op">+</span> <span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>
        <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="kw">out</span>, <span class="st">"mu_y"</span>) <span class="op">&lt;-</span> <span class="kw">mu</span>
        <span class="kw">out</span>
    }
    <span class="kw">score_eta_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">mu</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the derivative of the log density w.r.t. mu</span>
        <span class="kw">phis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">mu_phis</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">+</span> <span class="kw">phis</span>
        <span class="kw">comp2</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="kw">phis</span> <span class="op">/</span> <span class="kw">mu_phis</span>
        <span class="kw">comp3</span> <span class="op">&lt;-</span> <span class="kw">y</span> <span class="op">/</span> <span class="kw">mu</span> <span class="op">-</span> <span class="kw">y</span> <span class="op">/</span> <span class="kw">mu_phis</span>
        <span class="co"># the derivative of mu w.r.t. eta (this depends on the chosen link function)</span>
        <span class="kw">mu.eta</span> <span class="op">&lt;-</span> <span class="kw">mu</span>
        (<span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>) <span class="op">*</span> <span class="kw">mu.eta</span>
    }
    <span class="kw">score_phis_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">mu</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the derivative of the log density w.r.t. phis</span>
        <span class="kw">phis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">mu_phis</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">+</span> <span class="kw">phis</span>
        <span class="kw">comp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">y</span> <span class="op">+</span> <span class="kw">phis</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">phis</span>)
        <span class="kw">comp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">phis</span>) <span class="op">+</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">mu_phis</span>) <span class="op">-</span> <span class="kw">phis</span> <span class="op">/</span> <span class="kw">mu_phis</span>
        <span class="kw">comp3</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="kw">y</span> <span class="op">/</span> <span class="kw">mu_phis</span>
        (<span class="kw">comp1</span> <span class="op">+</span> <span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>) <span class="op">*</span> <span class="kw">phis</span>
    }
    <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(family = <span class="st">"user Neg Binom"</span>, link = <span class="kw">stats</span><span class="op">$</span><span class="kw">name</span>, linkfun = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkfun</span>,
                   linkinv = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkinv</span>, log_dens = <span class="kw">log_dens</span>,
                   score_eta_fun = <span class="kw">score_eta_fun</span>, score_phis_fun = <span class="kw">score_phis_fun</span>),
              class = <span class="st">"family"</span>)
}
</pre></div>
<p>And we fit the model</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
    <span class="kw">fm2</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(fixed = <span class="kw">y</span> <span class="op">~</span> <span class="kw">f1</span> <span class="op">*</span> <span class="kw">f2</span>, random = <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">g</span>, data = <span class="kw">dd</span>, 
                        family = <span class="fu">my_negBinom2</span>(), n_phis = <span class="fl">1</span>, 
                        initial_values = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"betas"</span> = <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>()))
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    1.89    0.00    1.89</span>

<span class="kw">fm2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ f1 * f2, random = ~1 | g, data = dd, </span>
<span class="co">#&gt;     family = my_negBinom2(), n_phis = 1, initial_values = list(betas = poisson()))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: user Neg Binom</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                 StdDev</span>
<span class="co">#&gt; (Intercept) 0.07476987</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt; (Intercept)         f12         f13         f2B     f12:f2B     f13:f2B </span>
<span class="co">#&gt;   1.6361832   0.6031425   1.0137677   1.5385349  -0.4378977  -0.5835306 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  -0.6477284 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -9994.062</span>
</pre></div>
<p>We obtain almost identical results, but in half of the computing time in this example. Depending on the size of the data set, the gain in computing time when the derivatives for <code>eta</code> and <code>phis</code> are provided can be much more substantial.</p>
</div>
<div id="students-t-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#students-t-mixed-effects-model" class="anchor"></a>Student’s t Mixed Effects Model</h2>
<p>We further illustrate the use of custom-made family objects by fitting a linear mixed model but with Student’s t distributed error terms. We start by simulating some data</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of subjects</span>
<span class="kw">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span>
<span class="kw">t_max</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we constuct a data frame with the design: </span>
<span class="co"># everyone has a baseline measurment, and then measurements at random follow-up times</span>
<span class="kw">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(id = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw">n</span>), each = <span class="kw">K</span>),
                 time = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="kw">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="kw">t_max</span>))))),
                 sex = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/gl.html">gl</a></span>(<span class="fl">2</span>, <span class="kw">n</span><span class="op">/</span><span class="fl">2</span>, labels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"male"</span>, <span class="st">"female"</span>)), each = <span class="kw">K</span>))

<span class="co"># design matrices for the fixed and random effects</span>
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MixMod%20Methods.html">model.matrix</a></span>(<span class="op">~</span> <span class="kw">sex</span> <span class="op">*</span> <span class="kw">time</span>, data = <span class="kw">DF</span>)
<span class="kw">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MixMod%20Methods.html">model.matrix</a></span>(<span class="op">~</span> <span class="kw">time</span>, data = <span class="kw">DF</span>)

<span class="kw">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">20.1</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span>) <span class="co"># fixed effects coefficients</span>
<span class="kw">sigma</span> <span class="op">&lt;-</span> <span class="fl">1.2</span> <span class="co"># scale parameter for the Student's t errors</span>
<span class="kw">D11</span> <span class="op">&lt;-</span> <span class="fl">1.5</span> <span class="co"># variance of random intercepts</span>
<span class="kw">D22</span> <span class="op">&lt;-</span> <span class="fl">1.2</span> <span class="co"># variance of random slopes</span>

<span class="co"># we simulate random effects</span>
<span class="kw">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>, sd = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">D11</span>)), <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>, sd = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">D22</span>)))
<span class="co"># linear predictor</span>
<span class="kw">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="kw">X</span> <span class="op">%*%</span> <span class="kw">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="kw">Z</span> <span class="op">*</span> <span class="kw">b</span>[<span class="kw">DF</span><span class="op">$</span><span class="kw">id</span>, ]))
<span class="co"># we simulate Student's t longitudinal data</span>
<span class="kw">DF</span><span class="op">$</span><span class="kw">y</span> <span class="op">&lt;-</span> <span class="kw">eta_y</span> <span class="op">+</span> <span class="kw">sigma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span>(<span class="kw">n</span> <span class="op">*</span> <span class="kw">K</span>, df = <span class="fl">4</span>)
</pre></div>
<p>Following we define the custom-made family object for the Student’s t distribution:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">students.t</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">df</span> = <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"'df' must be specified"</span>), <span class="kw">link</span> = <span class="st">"identity"</span>) {
    <span class="kw">.df</span> <span class="op">&lt;-</span> <span class="kw">df</span>
    <span class="kw">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span>(parent = <span class="kw">.GlobalEnv</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="st">".df"</span>, <span class="kw">df</span>, envir = <span class="kw">env</span>)
    <span class="kw">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/make.link.html">make.link</a></span>(<span class="kw">link</span>)
    <span class="kw">log_dens</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">eta</span>, <span class="kw">mu_fun</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the log density function</span>
        <span class="kw">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span>(x = (<span class="kw">y</span> <span class="op">-</span> <span class="kw">eta</span>) <span class="op">/</span> <span class="kw">sigma</span>, df = <span class="kw">.df</span>, log = <span class="fl">TRUE</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">sigma</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="kw">out</span>, <span class="st">"mu_y"</span>) <span class="op">&lt;-</span> <span class="kw">eta</span>
        <span class="kw">out</span>
    }
    <span class="kw">score_eta_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">mu</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the derivative of the log density w.r.t. mu</span>
        <span class="kw">sigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)<span class="op">^</span><span class="fl">2</span>
        <span class="kw">y_mu</span> <span class="op">&lt;-</span> <span class="kw">y</span> <span class="op">-</span> <span class="kw">mu</span>
        (<span class="kw">y_mu</span> <span class="op">*</span> (<span class="kw">.df</span> <span class="op">+</span> <span class="fl">1</span>) <span class="op">/</span> (<span class="kw">.df</span> <span class="op">*</span> <span class="kw">sigma2</span>)) <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="kw">y_mu</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> (<span class="kw">.df</span> <span class="op">*</span> <span class="kw">sigma2</span>))
    }
    <span class="kw">score_phis_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">mu</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="kw">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">y_mu2_df</span> <span class="op">&lt;-</span> (<span class="kw">y</span> <span class="op">-</span> <span class="kw">mu</span>)<span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="kw">.df</span>
        (<span class="kw">.df</span> <span class="op">+</span> <span class="fl">1</span>) <span class="op">*</span> <span class="kw">y_mu2_df</span> <span class="op">*</span> <span class="kw">sigma</span><span class="op">^</span>{<span class="op">-</span><span class="fl">2</span>} <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="kw">y_mu2_df</span> <span class="op">/</span> <span class="kw">sigma</span><span class="op">^</span><span class="fl">2</span>) <span class="op">-</span> <span class="fl">1</span>
    }
    <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(<span class="kw">log_dens</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(<span class="kw">score_eta_fun</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>(<span class="kw">score_phis_fun</span>) <span class="op">&lt;-</span> <span class="kw">env</span>
    <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(family = <span class="st">"Student's-t"</span>, link = <span class="kw">stats</span><span class="op">$</span><span class="kw">name</span>, linkfun = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkfun</span>,
                   linkinv = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkinv</span>, log_dens = <span class="kw">log_dens</span>, 
                   score_eta_fun = <span class="kw">score_eta_fun</span>, score_phis_fun = <span class="kw">score_phis_fun</span>),
              class = <span class="st">"family"</span>)
}
</pre></div>
<p>And we fit the model (results not shown)</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">fm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(<span class="kw">y</span> <span class="op">~</span> <span class="kw">sex</span> <span class="op">*</span> <span class="kw">time</span>, random = <span class="op">~</span> <span class="kw">time</span> <span class="op">|</span> <span class="kw">id</span>, data = <span class="kw">DF</span>, 
                   family = <span class="fu"><a href="../reference/Extra%20Family%20Objects.html">students.t</a></span>(<span class="fl">4</span>), n_phis = <span class="fl">1</span>, 
                   initial_values = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"betas"</span> = <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span>()))
</pre></div>
<p>As was the case also for the negative binomial model, the extra <code>phis</code> parameter has been appropriately transformed to have an unconstrained optimization of the likelihood. Hence, the estimated <code>sigma</code> parameter is given by <code><a href="https://rdrr.io/r/base/Log.html">exp(fm$phis)</a></code>.</p>
</div>
<div id="beta-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#beta-mixed-effects-model" class="anchor"></a>Beta Mixed-Effects Model</h2>
<p>As a final illustration we show how a beta mixed effects model can be fitted, i.e., applicable in case of bounded repeated measurements outcomes. We start again by simulating some data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of subjects</span>
<span class="kw">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span>
<span class="kw">t_max</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we constuct a data frame with the design: </span>
<span class="co"># everyone has a baseline measurment, and then measurements at random follow-up times</span>
<span class="kw">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(id = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw">n</span>), each = <span class="kw">K</span>),
                 time = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="kw">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="kw">t_max</span>))))),
                 sex = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/gl.html">gl</a></span>(<span class="fl">2</span>, <span class="kw">n</span><span class="op">/</span><span class="fl">2</span>, labels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"male"</span>, <span class="st">"female"</span>)), each = <span class="kw">K</span>))

<span class="co"># design matrices for the fixed and random effects</span>
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MixMod%20Methods.html">model.matrix</a></span>(<span class="op">~</span> <span class="kw">sex</span> <span class="op">*</span> <span class="kw">time</span>, data = <span class="kw">DF</span>)

<span class="kw">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span>) <span class="co"># fixed effects coefficients</span>
<span class="kw">phi</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># precision parameter of the Beta distribution</span>
<span class="kw">D11</span> <span class="op">&lt;-</span> <span class="fl">0.9</span> <span class="co"># variance of random intercepts</span>

<span class="co"># we simulate random effects</span>
<span class="kw">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>, sd = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">D11</span>))
<span class="co"># linear predictor</span>
<span class="kw">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="kw">X</span> <span class="op">%*%</span> <span class="kw">betas</span> <span class="op">+</span> <span class="kw">b</span>[<span class="kw">DF</span><span class="op">$</span><span class="kw">id</span>])
<span class="co"># mean</span>
<span class="kw">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span>(<span class="kw">eta_y</span>)
<span class="co"># we simulate beta longitudinal data</span>
<span class="kw">DF</span><span class="op">$</span><span class="kw">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="kw">n</span> <span class="op">*</span> <span class="kw">K</span>, shape1 = <span class="kw">mu</span> <span class="op">*</span> <span class="kw">phi</span>, shape2 = <span class="kw">phi</span> <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> <span class="kw">mu</span>))
<span class="co"># we transform to (0, 1)</span>
<span class="kw">DF</span><span class="op">$</span><span class="kw">y</span> <span class="op">&lt;-</span> (<span class="kw">DF</span><span class="op">$</span><span class="kw">y</span> <span class="op">*</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">DF</span>) <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="fl">0.5</span>) <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">DF</span>)
</pre></div>
<p>Next we define the custom-made family object as in the case of the Student’s t distribution:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">beta.fam</span> <span class="op">&lt;-</span> <span class="fu">function</span> () {
    <span class="kw">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/make.link.html">make.link</a></span>(<span class="st">"logit"</span>)
    <span class="kw">log_dens</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">eta</span>, <span class="kw">mu_fun</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the log density function</span>
        <span class="kw">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">mu</span> <span class="op">&lt;-</span> <span class="fu">mu_fun</span>(<span class="kw">eta</span>)
        <span class="kw">mu_phi</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">*</span> <span class="kw">phi</span>
        <span class="kw">comp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">phi</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">mu_phi</span>)
        <span class="kw">comp2</span> <span class="op">&lt;-</span> (<span class="kw">mu_phi</span> <span class="op">-</span> <span class="fl">1</span>) <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">y</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span>(<span class="kw">phi</span> <span class="op">-</span> <span class="kw">mu_phi</span>)
        <span class="kw">comp3</span> <span class="op">&lt;-</span> (<span class="kw">phi</span> <span class="op">-</span> <span class="kw">mu_phi</span> <span class="op">-</span> <span class="fl">1</span>) <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1</span> <span class="op">-</span> <span class="kw">y</span>)
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="kw">comp1</span> <span class="op">+</span> <span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>
        <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="kw">out</span>, <span class="st">"mu_y"</span>) <span class="op">&lt;-</span> <span class="kw">mu</span>
        <span class="kw">out</span>
    }
    <span class="kw">score_eta_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">mu</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="co"># the derivative of the log density w.r.t. mu</span>
        <span class="kw">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">mu_phi</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">*</span> <span class="kw">phi</span>
        <span class="kw">comp1</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">mu_phi</span>) <span class="op">*</span> <span class="kw">phi</span>
        <span class="kw">comp2</span> <span class="op">&lt;-</span> <span class="kw">phi</span> <span class="op">*</span> (<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">y</span>) <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">phi</span> <span class="op">-</span> <span class="kw">mu_phi</span>))
        <span class="kw">comp3</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="kw">phi</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1</span> <span class="op">-</span> <span class="kw">y</span>)
        <span class="co"># the derivative of mu w.r.t. eta (this depends on the chosen link function)</span>
        <span class="kw">mu.eta</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">-</span> <span class="kw">mu</span> <span class="op">*</span> <span class="kw">mu</span>
        (<span class="kw">comp1</span> <span class="op">+</span> <span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>) <span class="op">*</span> <span class="kw">mu.eta</span>
    }
    <span class="kw">score_phis_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">y</span>, <span class="kw">mu</span>, <span class="kw">phis</span>, <span class="kw">eta_zi</span>) {
        <span class="kw">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">phis</span>)
        <span class="kw">mu_phi</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">*</span> <span class="kw">phi</span>
        <span class="kw">mu1</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="kw">mu</span>
        <span class="kw">comp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">phi</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">mu_phi</span>) <span class="op">*</span> <span class="kw">mu</span>
        <span class="kw">comp2</span> <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">y</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">digamma</a></span>(<span class="kw">phi</span> <span class="op">-</span> <span class="kw">mu_phi</span>) <span class="op">*</span> <span class="kw">mu1</span>
        <span class="kw">comp3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1</span> <span class="op">-</span> <span class="kw">y</span>) <span class="op">*</span> <span class="kw">mu1</span>
        (<span class="kw">comp1</span> <span class="op">+</span> <span class="kw">comp2</span> <span class="op">+</span> <span class="kw">comp3</span>) <span class="op">*</span> <span class="kw">phi</span>
    }
    <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(family = <span class="st">"beta"</span>, link = <span class="kw">stats</span><span class="op">$</span><span class="kw">name</span>, linkfun = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkfun</span>,
                   linkinv = <span class="kw">stats</span><span class="op">$</span><span class="kw">linkinv</span>, log_dens = <span class="kw">log_dens</span>, 
                   score_eta_fun = <span class="kw">score_eta_fun</span>, score_phis_fun = <span class="kw">score_phis_fun</span>),
              class = <span class="st">"family"</span>)
}
</pre></div>
<p>And we fit the model</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">gm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(<span class="kw">y</span> <span class="op">~</span> <span class="kw">sex</span> <span class="op">*</span> <span class="kw">time</span>, random = <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">id</span>, data = <span class="kw">DF</span>,
                  family = <span class="fu"><a href="../reference/Extra%20Family%20Objects.html">beta.fam</a></span>(), n_phis = <span class="fl">1</span>)

<span class="kw">gm</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span>
<span class="co">#&gt;     family = beta.fam(), n_phis = 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: beta</span>
<span class="co">#&gt;  link: logit </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                StdDev</span>
<span class="co">#&gt; (Intercept) 0.9143138</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;    -2.04379396    -0.29655232     0.21844820    -0.05949062 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  1.69036 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: 581.2972</span>
</pre></div>
<p>To depict the results of the model we create an effects plot, showing the longitudinal evolution of the average/median male and female. We start by constructing the data frame that contains the values we want to depict, and using it in the <code><a href="../reference/effectPlotData.html">effectPlotData()</a></code> function; just for illustration, sandwich/robust standard errors are used in the calculation of the 95% poinwise cofidence intervals:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw">nDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="kw">DF</span>, <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">time</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">time</span>), length = <span class="fl">25</span>),
                            sex = <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="kw">sex</span>)))

<span class="kw">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/effectPlotData.html">effectPlotData</a></span>(<span class="kw">gm</span>, <span class="kw">nDF</span>, sandwich = <span class="fl">TRUE</span>)
</pre></div>
<p>The figure is created with a call to <code><a href="https://rdrr.io/pkg/lattice/man/xyplot.html">xyplot()</a></code> from the <a href="https://cran.r-project.org/package=lattice"><strong>lattice</strong></a> package:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st"><a href="http://lattice.r-forge.r-project.org">"lattice"</a></span>)
<span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html">xyplot</a></span>(<span class="kw">pred</span> <span class="op">+</span> <span class="kw">low</span> <span class="op">+</span> <span class="kw">upp</span> <span class="op">~</span> <span class="kw">time</span> <span class="op">|</span> <span class="kw">sex</span>, data = <span class="kw">plot_data</span>,
       type = <span class="st">"l"</span>, lty = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>), col = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>), lwd = <span class="fl">2</span>,
       xlab = <span class="st">"Follow-up Time"</span>, ylab = <span class="st">"Logit Scale"</span>)

<span class="kw">expit</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">x</span>) <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">x</span>))
<span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html">xyplot</a></span>(<span class="fu">expit</span>(<span class="kw">pred</span>) <span class="op">+</span> <span class="fu">expit</span>(<span class="kw">low</span>) <span class="op">+</span> <span class="fu">expit</span>(<span class="kw">upp</span>) <span class="op">~</span> <span class="kw">time</span> <span class="op">|</span> <span class="kw">sex</span>, data = <span class="kw">plot_data</span>,
       type = <span class="st">"l"</span>, lty = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>), col = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>), lwd = <span class="fl">2</span>,
       xlab = <span class="st">"Follow-up Time"</span>, ylab = <span class="st">"Original Scale"</span>)
</pre></div>
<p><img src="Custom_Models_files/figure-html/unnamed-chunk-13-1.png" width="816" style="display: block; margin: auto;"><img src="Custom_Models_files/figure-html/unnamed-chunk-13-2.png" width="816" style="display: block; margin: auto;"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://www.drizopoulos.com/">Dimitris Rizopoulos</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
