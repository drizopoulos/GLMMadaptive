<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Optimization and Numerical Integration in GLMMadaptive • GLMMadaptive</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Optimization and Numerical Integration in GLMMadaptive">
<meta property="og:description" content="GLMMadaptive">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GLMMadaptive</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Custom_Models.html">Custom Models</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/GLMMadaptive_basics.html">GLMMadaptive Basics</a>
    </li>
    <li>
      <a href="../articles/Goodness_of_Fit.html">Goodness of Fit for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Methods_MixMod.html">Methods for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Multiple_Comparisons.html">Multiple Comparisons for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Optimization.html">Optimization and Numerical Integration in GLMMadaptive</a>
    </li>
    <li>
      <a href="../articles/Ordinal_Mixed_Models.html">Mixed Models for Ordinal Data</a>
    </li>
    <li>
      <a href="../articles/ZeroInflated_and_TwoPart_Models.html">Zero-Inflated and Two-Part Mixed Effects Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/GLMMadaptive/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Optimization_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Optimization and Numerical Integration in GLMMadaptive</h1>
                        <h4 class="author">Dimitris Rizopoulos</h4>
            
            <h4 class="date">2020-06-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/GLMMadaptive/blob/master/vignettes/Optimization.Rmd"><code>vignettes/Optimization.Rmd</code></a></small>
      <div class="hidden name"><code>Optimization.Rmd</code></div>

    </div>

    
    
<div id="estimation-procedure" class="section level1">
<h1 class="hasAnchor">
<a href="#estimation-procedure" class="anchor"></a>Estimation Procedure</h1>
<p>As described in vignette GLMMadaptive basics (<code><a href="../articles/GLMMadaptive_basics.html">vignette("GLMMadaptive_basics", package = "GLMMadaptive")</a></code>), the log-likelihood function behind the mixed models fitted by <strong>GLMMadaptive</strong> contains an intractable integral over the random effects. In addition, the mode of the log-likelihood function cannot be calculated analytically. Therefore, maximum likelihood estimation requires a combination of numerical integration and optimization.</p>
<p>For the numerical optimization two, interlinked by default, algorithms are implemented. An EM algorithm in which the random effects are treated as ‘missing data’, and a quasi-Newton algorithm for direct optimization. The EM algorithm is often a more stable algorithm, especially when the initial values are far from the mode of the log-likelihood; however, because it has a linear convergence rate it can be slow reaching the mode. On the other hand, quasi-Newton algorithms typically have a super-linear convergence rate, but they may have trouble if they are initiated far from the mode. For this reason, optimization procedure in <strong>GLMMadaptive</strong> starts with the EM algorithm for a fixed number of iterations that are used as a refinement of the initial values before switching to the quasi-Newton algorithm.</p>
<p>The numerical integration over the random effects is done using the adaptive Gauss-Hermite quadrature rule. This also requires an optimization step of finding the modes of the complete-data (= observed response variable and unobserved random effects) log-likelihood with respect to the random effects, <em>for each sample unit</em>. To decrease the computational cost, the optimization procedure in <strong>GLMMadaptive</strong> does not locate these modes of the random effects in every iteration but every few iterations of the optimization procedure.</p>
<p>The <code>control</code> argument of function <code><a href="../reference/mixed_model.html">mixed_model()</a></code> has a number of arguments that enable the user to determine how the numerical integration and optimization procedure are performed. The relevant arguments are:</p>
<ul>
<li><p><code>nAGQ</code> the number of quadrature points; default is 11 for one and two-dimensional random effects vectors, and 7 otherwise.</p></li>
<li><p><code>iter_EM</code> the number of the first-phase EM iterations; default is 30.</p></li>
<li><p><code>update_GH_every</code> every how many EM iterations the modes of the random effects conditional distribution will be located for the adaptive Gauss-Hermite rule; default is 10.</p></li>
<li><p><code>optimizer</code> sets the optimizer, options are <code>"optim"</code> (default) and <code>"nlminb"</code>.</p></li>
<li><p><code>optim_method</code> if the optimizer is <code>"optim"</code>, you can set here the algorithm to be used, from the available options of the <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> function.</p></li>
<li><p><code>iter_qN_outer</code> the number of outer quasi-Newton iterations; every outer quasi-Newton iteration the modes of the random effects conditional distribution are located (i.e., this is the analogous argument for the quasi-Newton phase as the <code>update_GH_every</code> was described above for the EM-phase).</p></li>
<li><p><code>iter_qN</code> the number of iterations the quasi-Newton algorithm runs for each out iteration; default is 10, but see also the following argument.</p></li>
<li><p><code>iter_qN_incr</code> the increment in the <code>iter_qN</code> iterations after each outer iteration; default is 10.</p></li>
<li><p><code>parscale_betas</code>, <code>parscale_D</code>, <code>parscale_phis</code> and <code>parscale_phis</code> vectors of scaling values for the different sets of parameters, with ‘betas’ corresponding to the fixed effects, ‘D’ the unique elements of the covariance matrix of the random effects, ‘phis’ extra dispersion/scale parameters, and ‘gammas’ the fixed effects for the extra zeros-part, relevant for zero-inflated and hurdle models.</p></li>
</ul>
<div id="controlling-the-optimization-and-integration" class="section level2">
<h2 class="hasAnchor">
<a href="#controlling-the-optimization-and-integration" class="anchor"></a>Controlling the Optimization and Integration</h2>
<p>We start by simulating some data for a binary longitudinal outcome:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">300</span> <span class="co"># number of subjects</span>
<span class="no">K</span> <span class="kw">&lt;-</span> <span class="fl">4</span> <span class="co"># number of measurements per subject</span>
<span class="no">t_max</span> <span class="kw">&lt;-</span> <span class="fl">15</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we constuct a data frame with the design: </span>
<span class="co"># everyone has a baseline measurment, and then measurements at K time points</span>
<span class="no">DF</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">n</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="no">K</span>),
                 <span class="kw">time</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/gl.html">gl</a></span>(<span class="no">K</span>, <span class="fl">1</span>, <span class="no">n</span>*<span class="no">K</span>, <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Time"</span>, <span class="fl">1</span>:<span class="no">K</span>)),
                 <span class="kw">sex</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/gl.html">gl</a></span>(<span class="fl">2</span>, <span class="no">n</span>/<span class="fl">2</span>, <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"male"</span>, <span class="st">"female"</span>)), <span class="kw">each</span> <span class="kw">=</span> <span class="no">K</span>))

<span class="co"># design matrices for the fixed and random effects</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span>(~ <span class="no">sex</span> * <span class="no">time</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">DF</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span>(~ <span class="fl">1</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">DF</span>)

<span class="no">betas</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2.13</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.2</span>, -<span class="fl">1.2</span>), <span class="no">K</span>-<span class="fl">1</span>)) <span class="co"># fixed effects coefficients</span>
<span class="no">D11</span> <span class="kw">&lt;-</span> <span class="fl">1</span> <span class="co"># variance of random intercepts</span>

<span class="co"># we simulate random effects</span>
<span class="no">b</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">D11</span>)))
<span class="co"># linear predictor</span>
<span class="no">eta_y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="no">X</span> <span class="kw">%*%</span> <span class="no">betas</span> + <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">Z</span> * <span class="no">b</span>[<span class="no">DF</span>$<span class="no">id</span>, ]))
<span class="co"># we simulate binary longitudinal data</span>
<span class="no">DF</span>$<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span> * <span class="no">K</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span>(<span class="no">eta_y</span>))</pre></body></html></div>
<p>We fit a mixed effects logistic regression for <code>y</code> assuming random intercepts for the random-effects part, and the main effects of <code>sex</code> and <code>time</code> for the fixed-effects part. In the call to <code><a href="../reference/mixed_model.html">mixed_model()</a></code>, we are using the default values for the control arguments:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(<span class="kw">fixed</span> <span class="kw">=</span> <span class="no">y</span> ~ <span class="no">sex</span> + <span class="no">time</span>, <span class="kw">random</span> <span class="kw">=</span> ~ <span class="fl">1</span> <span class="kw">|</span> <span class="no">id</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">DF</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())</pre></body></html></div>
<p>In the following example we do not use any EM iterations, and we specify as optimizer the <code>nlimnb()</code> function. In addition, during each iteration of the outer loop in which the modes of the modes of the conditional distribution of the random effects are relocated, we increase the number of the quasi-Newton iterations by 5:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(<span class="kw">fixed</span> <span class="kw">=</span> <span class="no">y</span> ~ <span class="no">sex</span> + <span class="no">time</span>, <span class="kw">random</span> <span class="kw">=</span> ~ <span class="fl">1</span> <span class="kw">|</span> <span class="no">id</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">DF</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>(),
            <span class="kw">iter_EM</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">optimizer</span> <span class="kw">=</span> <span class="st">"nlminb"</span>, <span class="kw">iter_qN_incr</span> <span class="kw">=</span> <span class="fl">5</span>)</pre></body></html></div>
<p>In the following call, we allow again for EM iterations, but we set the number of the iterations to 1000 giving the option to achieve convergence only during the EM-phase. In addition, we set to update the modes of the conditional distribution of the random effects every 5 iterations, and we also set the number of quadrature points to 21:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(<span class="kw">fixed</span> <span class="kw">=</span> <span class="no">y</span> ~ <span class="no">sex</span> + <span class="no">time</span>, <span class="kw">random</span> <span class="kw">=</span> ~ <span class="fl">1</span> <span class="kw">|</span> <span class="no">id</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">DF</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>(),
            <span class="kw">iter_EM</span> <span class="kw">=</span> <span class="fl">1000</span>, <span class="kw">update_GH_every</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">nAGQ</span> <span class="kw">=</span> <span class="fl">21</span>)</pre></body></html></div>
<p>To not run the optimization procedure at all, we need to also to set <code>iter_qN_outer</code> to 0, e.g.,</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span>(<span class="kw">fixed</span> <span class="kw">=</span> <span class="no">y</span> ~ <span class="no">sex</span> + <span class="no">time</span>, <span class="kw">random</span> <span class="kw">=</span> ~ <span class="fl">1</span> <span class="kw">|</span> <span class="no">id</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">DF</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>(),
            <span class="kw">iter_EM</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">iter_qN_outer</span> <span class="kw">=</span> <span class="fl">0</span>)</pre></body></html></div>
</div>
<div id="advice-on-optimization-and-numerical-integration-control" class="section level2">
<h2 class="hasAnchor">
<a href="#advice-on-optimization-and-numerical-integration-control" class="anchor"></a>Advice on optimization and numerical integration control</h2>
<ul>
<li><p>Even though, as mentioned above, the EM algorithm is a more stable algorithm than the quasi-Newton, it can happen in some occasions that it can overshoot and fail to bring the parameters into the neighborhood of the (local) maximum. In these cases you can set to <code>iter_EM = 0</code> to only use the quasi-Newton part of the optimization procedure.</p></li>
<li><p>Convergence problems may sometimes be attributed to initial values. The <code>initial_values</code> argument of <code><a href="../reference/mixed_model.html">mixed_model()</a></code> can be used to override the default algorithm that calculate these values. For example, in the case of a random intercepts and random slopes model, we could set the initial values for the fixed effects to zero, the variance of the intercepts to 0.5, the variance of the slopes to 0.1 and their covariance to zero by <code><a href="../reference/mixed_model.html">mixed_model(..., initial_values = list(betas = rep(0, n_fixed_effects), D = matrix(c(0.5, 0, 0, 0.1), 2, 2)))</a></code>.</p></li>
<li><p>Coefficients that are several orders of the magnitude different in absolute value can also lead to convergence issues. In such cases it helps to scale variable such that the coefficients are on the same magnitude.</p></li>
<li><p>For dichotomous and count data (complete) separation issues may be encountered. In such cases you can invoke the <code>penalized</code> argument of <code><a href="../reference/mixed_model.html">mixed_model()</a></code> that places a Student’s t penalty on the fixed effects coefficients. The default mean is zero, the default scale is one, and the degrees of freedom are three.</p></li>
<li><p>With regard to the number of quadrature points, a general advice is to increase them until the coefficients and log-likelihood value seem to be stabilized. However, if you too many quadrature points are put these may also lead to overflow problems. In the majority of the cases, 11 to 15 quadrature points suffice.</p></li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://www.drizopoulos.com/">Dimitris Rizopoulos</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
