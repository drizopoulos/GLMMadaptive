<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zero-Inflated and Two-Part Mixed Effects Models â€¢ GLMMadaptive</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Zero-Inflated and Two-Part Mixed Effects Models">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GLMMadaptive</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Custom_Models.html">Custom Models</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/GLMMadaptive_basics.html">GLMMadaptive Basics</a>
    </li>
    <li>
      <a href="../articles/Goodness_of_Fit.html">Goodness of Fit for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Methods_MixMod.html">Methods for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Multiple_Comparisons.html">Multiple Comparisons for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/ZeroInflated_and_TwoPart_Models.html">Zero-Inflated and Two-Part Mixed Effects Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/GLMMadaptive">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Zero-Inflated and Two-Part Mixed Effects Models</h1>
                        <h4 class="author">Dimitris Rizopoulos</h4>
            
            <h4 class="date">2018-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/GLMMadaptive/blob/master/vignettes/ZeroInflated_and_TwoPart_Models.Rmd"><code>vignettes/ZeroInflated_and_TwoPart_Models.Rmd</code></a></small>
      <div class="hidden name"><code>ZeroInflated_and_TwoPart_Models.Rmd</code></div>

    </div>

    
    
<div id="mixed-models-with-an-extra-zero-part" class="section level1">
<h1 class="hasAnchor">
<a href="#mixed-models-with-an-extra-zero-part" class="anchor"></a>Mixed Models with an Extra Zero Part</h1>
<p>Function <code><a href="../reference/mixed_model.html">mixed_model()</a></code> of <strong>GLMMadaptive</strong> can also be used to fit zero-inflated and two-part mixed effects models. For both types of models, a suitable <code>family</code> object needs to be specified as outlined in the vignette <a href="http://www.drizopoulos.com/vignettes/Custom_Models.html">Custom Models</a>, and also arguments <code>zi_fixed</code> and <code>zi_random</code> of <code><a href="../reference/mixed_model.html">mixed_model()</a></code> come into play. In these arguments, the user can specify the fixed and random effects <code>formulas</code> of the logistic regression for the zero-part of the distribution of the outcome. We should note that the user has the option to leave <code>zi_random</code> set to <code>NULL</code>, in which case for the zero-part we have a logistic regression with only fixed effects and no random effects.</p>
<p>In addition, in the specification of the <code>family</code> object, and in order to better facilitate the internal computations, the user may specify the function <code>score_eta_zi_fun</code> that calculates the derivative of the log probability density function or the log probability mass function with respect to <code>eta_zi</code> that denotes the linear predictor of the logistic regression for the zero part. Here we provide three examples to illustrate how such models can be fitted.</p>
<div id="zero-inflated-poisson-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#zero-inflated-poisson-mixed-effects-model" class="anchor"></a>Zero-Inflated Poisson Mixed Effects Model</h2>
<p>We start our illustrations by showing how we can fit a zero-inflated Poisson mixed effects model. The specification of the required <code>family</code> object is already available in the package as the object returned by <code><a href="../reference/extra_fams.html">zi.poisson()</a></code>. <em>Currently, only the log link is allowed.</em> First, we simulate longitudinal data from a zero-inflated negative binomial distribution:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1234</span>)
n &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co"># number of subjects</span>
K &lt;-<span class="st"> </span><span class="dv">8</span> <span class="co"># number of measurements per subject</span>
t_max &lt;-<span class="st"> </span><span class="dv">5</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we constuct a data frame with the design: </span>
<span class="co"># everyone has a baseline measurment, and then measurements at random follow-up times</span>
DF &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">rep</span>(<span class="kw">seq_len</span>(n), <span class="dt">each =</span> K),
                 <span class="dt">time =</span> <span class="kw">c</span>(<span class="kw">replicate</span>(n, <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">sort</span>(<span class="kw">runif</span>(K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">0</span>, t_max))))),
                 <span class="dt">sex =</span> <span class="kw">rep</span>(<span class="kw">gl</span>(<span class="dv">2</span>, n<span class="op">/</span><span class="dv">2</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"male"</span>, <span class="st">"female"</span>)), <span class="dt">each =</span> K))

<span class="co"># design matrices for the fixed and random effects non-zero part</span>
X &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">data =</span> DF)
Z &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> DF)
<span class="co"># design matrices for the fixed and random effects zero part</span>
X_zi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>sex, <span class="dt">data =</span> DF)
Z_zi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> DF)

betas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.03</span>) <span class="co"># fixed effects coefficients non-zero part</span>
shape &lt;-<span class="st"> </span><span class="dv">2</span> <span class="co"># shape/size parameter of the negative binomial distribution</span>
gammas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span>) <span class="co"># fixed effects coefficients zero part</span>
D11 &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="co"># variance of random intercepts non-zero part</span>
D22 &lt;-<span class="st"> </span><span class="fl">0.4</span> <span class="co"># variance of random intercepts zero part</span>

<span class="co"># we simulate random effects</span>
b &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D11)), <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D22)))
<span class="co"># linear predictor non-zero part</span>
eta_y &lt;-<span class="st"> </span><span class="kw">as.vector</span>(X <span class="op">%*%</span><span class="st"> </span>betas <span class="op">+</span><span class="st"> </span><span class="kw">rowSums</span>(Z <span class="op">*</span><span class="st"> </span>b[DF<span class="op">$</span>id, <span class="dv">1</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>]))
<span class="co"># linear predictor zero part</span>
eta_zi &lt;-<span class="st"> </span><span class="kw">as.vector</span>(X_zi <span class="op">%*%</span><span class="st"> </span>gammas <span class="op">+</span><span class="st"> </span><span class="kw">rowSums</span>(Z_zi <span class="op">*</span><span class="st"> </span>b[DF<span class="op">$</span>id, <span class="dv">2</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>]))
<span class="co"># we simulate negative binomial longitudinal data</span>
DF<span class="op">$</span>y &lt;-<span class="st"> </span><span class="kw">rnbinom</span>(n <span class="op">*</span><span class="st"> </span>K, <span class="dt">size =</span> shape, <span class="dt">mu =</span> <span class="kw">exp</span>(eta_y))
<span class="co"># we set the extra zeros</span>
DF<span class="op">$</span>y[<span class="kw">as.logical</span>(<span class="kw">rbinom</span>(n <span class="op">*</span><span class="st"> </span>K, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="kw">plogis</span>(eta_zi)))] &lt;-<span class="st"> </span><span class="dv">0</span></code></pre></div>
<p>A zero-inflated Poisson mixed model with only fixed effects in the zero part is fitted with the following call to <code><a href="../reference/mixed_model.html">mixed_model()</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fm1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixed_model.html">mixed_model</a></span>(y <span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id, <span class="dt">data =</span> DF,
                   <span class="dt">family =</span> <span class="kw"><a href="../reference/extra_fams.html">zi.poisson</a></span>(), <span class="dt">zi_fixed =</span> <span class="op">~</span><span class="st"> </span>sex)

fm1
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span>
<span class="co">#&gt;     family = zi.poisson(), zi_fixed = ~sex)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: zero-inflated poisson</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                StdDev</span>
<span class="co">#&gt; (Intercept) 0.8272898</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;   1.5275644687   0.0173647260  -0.0040365383   0.0004326841 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;   -1.210597    0.498611 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -2223.937</span></code></pre></div>
<p>As noted above, only the log link is currently available for the non-zero part and the logit link for the zero part. Hence, the estimated fixed effects for the two parts are interpreted accordingly. We extend <code>fm1</code> by allowing also for random intercepts in the zero part. We should note that by default the random intercept of the non-zero part is correlated with the random intercept from the zero part:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fm2 &lt;-<span class="st"> </span><span class="kw">update</span>(fm1, <span class="dt">zi_random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id)

fm2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span>
<span class="co">#&gt;     family = zi.poisson(), zi_fixed = ~sex, zi_random = ~1 | </span>
<span class="co">#&gt;         id)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: zero-inflated poisson</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                 StdDev    Corr</span>
<span class="co">#&gt; (Intercept)     0.7391        </span>
<span class="co">#&gt; zi_(Intercept)  0.7157 -0.6334</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;   1.5902225072  -0.0117290754  -0.0029500093   0.0001046371 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.1201182   0.4416912 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -2214.306</span></code></pre></div>
<p>We test if we need the extra random effect using a likelihood ratio test:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/methods.html">anova</a></span>(fm1, fm2)
<span class="co">#&gt; </span>
<span class="co">#&gt;         AIC     BIC  log.Lik   LRT df p.value</span>
<span class="co">#&gt; fm1 4461.87 4480.11 -2223.94                 </span>
<span class="co">#&gt; fm2 4446.61 4446.61 -2214.31 19.26  2   1e-04</span></code></pre></div>
<p>The results suggest that the extra random effect improves the fit of the model.</p>
</div>
<div id="zero-inflated-negative-binomial-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#zero-inflated-negative-binomial-mixed-effects-model" class="anchor"></a>Zero-Inflated Negative Binomial Mixed Effects Model</h2>
<p>We continue with the same data, but we now take into account the potential over-dispersion in the data using a zero-inflated negative binomial model. To fit this mixed model we use an almost identical syntax to what we just did above - the only difference is that we now specify as family the <code><a href="../reference/extra_fams.html">zi.negative.binomial()</a></code> object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gm1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixed_model.html">mixed_model</a></span>(y <span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id, <span class="dt">data =</span> DF,
                   <span class="dt">family =</span> <span class="kw"><a href="../reference/extra_fams.html">zi.negative.binomial</a></span>(), <span class="dt">zi_fixed =</span> <span class="op">~</span><span class="st"> </span>sex)

gm1
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span>
<span class="co">#&gt;     family = zi.negative.binomial(), zi_fixed = ~sex)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: zero-inflated negative binomial</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                StdDev</span>
<span class="co">#&gt; (Intercept) 0.8291406</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;    1.471442764    0.027018363    0.003096235   -0.006574982 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.5551763   0.5913118 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; dispersion parameter:</span>
<span class="co">#&gt;  2.227321 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -1958.746</span></code></pre></div>
<p>Similarly to <code>fm1</code>, in <code>gm1</code> we specified only fixed effects for the logistic regression for the zero part. We now compare this model with the zero-inflated Poisson model that allowed for a random intercept in the zero part. The comparison can be done with the <code><a href="../reference/methods.html">anova()</a></code> method; because the two models are not nested, we set <code>test = FALSE</code> in the call to <code><a href="../reference/methods.html">anova()</a></code>, i.e.:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/methods.html">anova</a></span>(gm1, fm2, <span class="dt">test =</span> <span class="ot">FALSE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt;         AIC     BIC  log.Lik df</span>
<span class="co">#&gt; gm1 3933.49 3954.33 -1958.75   </span>
<span class="co">#&gt; fm2 4446.61 4446.61 -2214.31  1</span></code></pre></div>
<p>We observe that accounting for the over-dispersion seems to better improve the fit than including the random intercepts term in the zero part.</p>
</div>
<div id="two-part-mixed-effects-model-for-semi-continuous-data" class="section level2">
<h2 class="hasAnchor">
<a href="#two-part-mixed-effects-model-for-semi-continuous-data" class="anchor"></a>Two-Part Mixed Effects Model for Semi-Continuous Data</h2>
<p>To further illustrate the flexibility provided by <strong>GLMMadaptive</strong> in allowing users to specify their own family objects with a specific log density function, we consider the setting of multivariate semi-continuous data. That is, continuous data with excess zeros. In the literature the class of two-part / hurdle mixed models has been proposed to analyze such data. These models specify a logistic regression for the dichotomous indicator that the outcome is zero or not, and a standard linear mixed model for the logarithmic transformation of the non-zero responses.</p>
<p>We start again by simulating some longitudinal data from this model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1234</span>)
n &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co"># number of subjects</span>
K &lt;-<span class="st"> </span><span class="dv">8</span> <span class="co"># number of measurements per subject</span>
t_max &lt;-<span class="st"> </span><span class="dv">5</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we constuct a data frame with the design: </span>
<span class="co"># everyone has a baseline measurment, and then measurements at random follow-up times</span>
DF &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">rep</span>(<span class="kw">seq_len</span>(n), <span class="dt">each =</span> K),
                 <span class="dt">time =</span> <span class="kw">c</span>(<span class="kw">replicate</span>(n, <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">sort</span>(<span class="kw">runif</span>(K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">0</span>, t_max))))),
                 <span class="dt">sex =</span> <span class="kw">rep</span>(<span class="kw">gl</span>(<span class="dv">2</span>, n<span class="op">/</span><span class="dv">2</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"male"</span>, <span class="st">"female"</span>)), <span class="dt">each =</span> K))

<span class="co"># design matrices for the fixed and random effects non-zero part</span>
X &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">data =</span> DF)
Z &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>time, <span class="dt">data =</span> DF)
<span class="co"># design matrices for the fixed and random effects zero part</span>
X_zi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>sex, <span class="dt">data =</span> DF)
Z_zi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> DF)

betas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">2.13</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span>) <span class="co"># fixed effects coefficients non-zero part</span>
sigma &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="co"># standard deviation error terms non-zero part</span>
gammas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span>) <span class="co"># fixed effects coefficients zero part</span>
D11 &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="co"># variance of random intercepts non-zero part</span>
D22 &lt;-<span class="st"> </span><span class="fl">0.1</span> <span class="co"># variance of random slopes non-zero part</span>
D33 &lt;-<span class="st"> </span><span class="fl">0.4</span> <span class="co"># variance of random intercepts zero part</span>

<span class="co"># we simulate random effects</span>
b &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D11)), <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D22)), <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D33)))
<span class="co"># linear predictor non-zero part</span>
eta_y &lt;-<span class="st"> </span><span class="kw">as.vector</span>(X <span class="op">%*%</span><span class="st"> </span>betas <span class="op">+</span><span class="st"> </span><span class="kw">rowSums</span>(Z <span class="op">*</span><span class="st"> </span>b[DF<span class="op">$</span>id, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>]))
<span class="co"># linear predictor zero part</span>
eta_zi &lt;-<span class="st"> </span><span class="kw">as.vector</span>(X_zi <span class="op">%*%</span><span class="st"> </span>gammas <span class="op">+</span><span class="st"> </span><span class="kw">rowSums</span>(Z_zi <span class="op">*</span><span class="st"> </span>b[DF<span class="op">$</span>id, <span class="dv">3</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>]))
<span class="co"># we simulate log-normal longitudinal data</span>
DF<span class="op">$</span>y &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">rnorm</span>(n <span class="op">*</span><span class="st"> </span>K, <span class="dt">mean =</span> eta_y, <span class="dt">sd =</span> sigma))
<span class="co"># we set the zeros from the logistic regression</span>
DF<span class="op">$</span>y[<span class="kw">as.logical</span>(<span class="kw">rbinom</span>(n <span class="op">*</span><span class="st"> </span>K, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="kw">plogis</span>(eta_zi)))] &lt;-<span class="st"> </span><span class="dv">0</span></code></pre></div>
<p>To fit the two-part mixed model for log-normal data we can use the already build-in <code><a href="../reference/extra_fams.html">hurdle.lognormal()</a></code> family object. However, just as an illustration, and to show that users can define their own family objects to be used in <code><a href="../reference/mixed_model.html">mixed_model()</a></code>, we explain how exactly <code><a href="../reference/extra_fams.html">hurdle.lognormal()</a></code> is specified. To define the family object: The minimal requirement is to specify the <code>log_dens</code> component and the link function; however, as also explained in the <a href="http://www.drizopoulos.com/vignettes/Custom_Models.html">Custom Models</a> vignette, the internal calculations will be faster and more stable if the user also specifies the score vector for the linear predictor of the non-zero part (function <code>score_eta_fun()</code>), the derivative of the log density with respect to <code>phis</code> (function <code>score_phis_fun()</code>), and because we have a model with a zero part, also the derivative of the log density with respect to the linear predictor of the zero part (function <code>score_eta_zi_fun()</code>). Finally, for being able to simulate from the model using the <code><a href="../reference/methods.html">simulate()</a></code> method, the function <code><a href="../reference/methods.html">simulate()</a></code> within the family object can also be specified. Hence, the family object for the two-part model is defined as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hurdle.lognormal &lt;-<span class="st"> </span><span class="cf">function</span> () {
    stats &lt;-<span class="st"> </span><span class="kw">make.link</span>(<span class="st">"identity"</span>)
    log_dens &lt;-<span class="st"> </span><span class="cf">function</span> (y, eta, mu_fun, phis, eta_zi) {
        sigma &lt;-<span class="st"> </span><span class="kw">exp</span>(phis)
        <span class="co"># binary indicator for y &gt; 0</span>
        ind &lt;-<span class="st"> </span>y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>
        <span class="co"># non-zero part</span>
        eta &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(eta)
        eta_zi &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(eta_zi)
        out &lt;-<span class="st"> </span>eta
        out[ind, ] &lt;-<span class="st"> </span><span class="kw">plogis</span>(eta_zi[ind, ], <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>, <span class="dt">log.p =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">            </span><span class="kw">dnorm</span>(<span class="dt">x =</span> <span class="kw">log</span>(y[ind]), <span class="dt">mean =</span> eta[ind, ], <span class="dt">sd =</span> sigma, <span class="dt">log =</span> <span class="ot">TRUE</span>)
        <span class="co"># zero part</span>
        out[<span class="op">!</span>ind, ] &lt;-<span class="st"> </span><span class="kw">plogis</span>(eta_zi[<span class="op">!</span>ind, ], <span class="dt">log.p =</span> <span class="ot">TRUE</span>)
        <span class="kw">attr</span>(out, <span class="st">"mu_y"</span>) &lt;-<span class="st"> </span>eta
        out
    }
    score_eta_fun &lt;-<span class="st"> </span><span class="cf">function</span> (y, mu, phis, eta_zi) {
        sigma &lt;-<span class="st"> </span><span class="kw">exp</span>(phis)
        <span class="co"># binary indicator for y &gt; 0</span>
        ind &lt;-<span class="st"> </span>y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>
        <span class="co"># non-zero part</span>
        eta &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(mu)
        out &lt;-<span class="st"> </span>eta
        out[<span class="op">!</span>ind, ] &lt;-<span class="st"> </span><span class="dv">0</span>
        out[ind, ] &lt;-<span class="st"> </span>(<span class="kw">log</span>(y[ind]) <span class="op">-</span><span class="st"> </span>eta[ind, ]) <span class="op">/</span><span class="st"> </span>sigma<span class="op">^</span><span class="dv">2</span>
        out
    }
    score_eta_zi_fun &lt;-<span class="st"> </span><span class="cf">function</span> (y, mu, phis, eta_zi) {
        ind &lt;-<span class="st"> </span>y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>
        probs &lt;-<span class="st"> </span><span class="kw">plogis</span>(<span class="kw">as.matrix</span>(eta_zi))
        out &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>probs
        out[ind, ] &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span>probs[ind, ]
        out
    }
    score_phis_fun &lt;-<span class="st"> </span><span class="cf">function</span> (y, mu, phis, eta_zi) {
        sigma &lt;-<span class="st"> </span><span class="kw">exp</span>(phis)
        <span class="co"># binary indicator for y &gt; 0</span>
        ind &lt;-<span class="st"> </span>y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>
        <span class="co"># non-zero part</span>
        eta &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(mu)
        out &lt;-<span class="st"> </span>eta
        out[<span class="op">!</span>ind, ] &lt;-<span class="st"> </span><span class="dv">0</span>
        out[ind, ] &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="kw">log</span>(y[ind]) <span class="op">-</span><span class="st"> </span>eta[ind, ])<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>sigma<span class="op">^</span><span class="dv">2</span>
        out
    }
    simulate &lt;-<span class="st"> </span><span class="cf">function</span> (n, mu, phis, eta_zi) {
        y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> n, <span class="dt">mean =</span> mu, <span class="dt">sd =</span> <span class="kw">exp</span>(phis))
        y[<span class="kw">as.logical</span>(<span class="kw">rbinom</span>(n, <span class="dv">1</span>, <span class="kw">plogis</span>(eta_zi)))] &lt;-<span class="st"> </span><span class="dv">0</span>
        y
    }
    <span class="kw">structure</span>(<span class="kw">list</span>(<span class="dt">family =</span> <span class="st">"two-part log-normal"</span>, <span class="dt">link =</span> stats<span class="op">$</span>name, 
                   <span class="dt">linkfun =</span> stats<span class="op">$</span>linkfun, <span class="dt">linkinv =</span> stats<span class="op">$</span>linkinv, <span class="dt">log_dens =</span> log_dens,
                   <span class="dt">score_eta_fun =</span> score_eta_fun, <span class="dt">score_eta_zi_fun =</span> score_eta_zi_fun,
                   <span class="dt">score_phis_fun =</span> score_phis_fun, <span class="dt">simulate =</span> simulate),
              <span class="dt">class =</span> <span class="st">"family"</span>)
}</code></pre></div>
<p>Then to fit the model, we provide the user-defined family object in the <code>family</code> argument of <code><a href="../reference/mixed_model.html">mixed_model()</a></code>, specifying also that we have one dispersion parameter in the family (i.e., <code>n_phis = 1</code>), and that in the zero part we only include fixed effects:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">km1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixed_model.html">mixed_model</a></span>(y <span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id, <span class="dt">data =</span> DF, 
                  <span class="dt">family =</span> <span class="kw"><a href="../reference/extra_fams.html">hurdle.lognormal</a></span>(), <span class="dt">n_phis =</span> <span class="dv">1</span>,
                  <span class="dt">zi_fixed =</span> <span class="op">~</span><span class="st"> </span>sex)

km1
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span>
<span class="co">#&gt;     family = hurdle.lognormal(), zi_fixed = ~sex, n_phis = 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: two-part log-normal</span>
<span class="co">#&gt;  link: identity </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                StdDev</span>
<span class="co">#&gt; (Intercept) 0.9615228</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;    -2.08102787    -0.24015083     0.22302346    -0.05696434 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.6034499   0.6713555 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  -0.3352479 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -1214.208</span></code></pre></div>
<p>The estimated standard deviation for the error terms is <code>exp(phis) =</code> 0.7 We extend the model by allowing for a random intercept in the zero-part, but using the <code>||</code> symbol in the <code>random</code> argument we specify the covariance matrix of the random effects is diagonal; hence, that the two random intercepts terms are uncorrelated:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">km2 &lt;-<span class="st"> </span><span class="kw">update</span>(km1, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">||</span><span class="st"> </span>id, <span class="dt">zi_random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id)

km2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 || id, data = DF, </span>
<span class="co">#&gt;     family = hurdle.lognormal(), zi_fixed = ~sex, zi_random = ~1 | </span>
<span class="co">#&gt;         id, n_phis = 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: two-part log-normal</span>
<span class="co">#&gt;  link: identity </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                StdDev</span>
<span class="co">#&gt; (Intercept)    0.9619</span>
<span class="co">#&gt; zi_(Intercept) 0.6043</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;    -2.08026578    -0.24025852     0.22301074    -0.05698636 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.7160273   0.7096789 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  -0.3350702 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -1210.313</span></code></pre></div>
<p>Finally, we show how the <code><a href="../reference/methods.html">simulate()</a></code> method can be used to perform a replication / posterior predictive check. In particular, in the following code we compare the empirical distribution function estimated in the observed data with estimates of the empirical distribution function obtained from simulated/replicated data from the model. In the call to <code><a href="../reference/methods.html">simulate()</a></code> below we also specify to account for the variability in the maximum likelihood estimates by setting <code>acount_MLEs_var = TRUE</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">2.5</span>, <span class="fl">2.5</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">mgp =</span> <span class="kw">c</span>(<span class="fl">1.1</span>, <span class="fl">0.5</span>, <span class="dv">0</span>), <span class="dt">cex.axis =</span> <span class="fl">0.7</span>, <span class="dt">cex.lab =</span> <span class="fl">0.8</span>)
y &lt;-<span class="st"> </span>DF<span class="op">$</span>y
y[y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="kw">log</span>(y[y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>])
x_vals &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(y), <span class="kw">max</span>(y), <span class="dt">length.out =</span> <span class="dv">500</span>)
out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">simulate</a></span>(km2, <span class="dt">nsim =</span> <span class="dv">30</span>, <span class="dt">acount_MLEs_var =</span> <span class="ot">TRUE</span>)
ind &lt;-<span class="st"> </span>out <span class="op">&gt;</span><span class="st"> </span><span class="kw">sqrt</span>(.Machine<span class="op">$</span>double.eps)
out[ind] &lt;-<span class="st"> </span><span class="kw">log</span>(out[ind])
rep_y &lt;-<span class="st"> </span><span class="kw">apply</span>(out, <span class="dv">2</span>, <span class="cf">function</span> (x, x_vals) <span class="kw">ecdf</span>(x)(x_vals), <span class="dt">x_vals =</span> x_vals)
<span class="kw">matplot</span>(x_vals, rep_y, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">"lightgrey"</span>, 
        <span class="dt">xlab =</span> <span class="st">"Response Variable"</span>, <span class="dt">ylab =</span> <span class="st">"Empirical CDF"</span>)
<span class="kw">lines</span>(x_vals, <span class="kw">ecdf</span>(y)(x_vals))
<span class="kw">legend</span>(<span class="st">"bottomright"</span>, <span class="kw">c</span>(<span class="st">"log replicated data"</span>, <span class="st">"log observed data"</span>), <span class="dt">lty =</span> <span class="dv">1</span>, 
       <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"black"</span>), <span class="dt">bty =</span> <span class="st">"n"</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</code></pre></div>
<p><img src="ZeroInflated_and_TwoPart_Models_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="two-parthurdle-poisson-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#two-parthurdle-poisson-mixed-effects-model" class="anchor"></a>Two-Part/Hurdle Poisson Mixed Effects Model</h2>
<p>An alternative modeling framework to account for high percentages of 0 in count data is hurdle models. These models are similar to the two-part model for semi-continuous data presented above. The difference is that for the positive part we have positive counts instead of a positive continuous outcome. For the positive counts, a truncated at zero Poisson or negative binomial distribution is typically used. Both hurdle Poisson and hurdle negative binomial mixed models can be fitted by <code><a href="../reference/mixed_model.html">mixed_model()</a></code> using the family objects <code><a href="../reference/extra_fams.html">hurdle.poisson()</a></code> and <code>hurdle.negative.binomial</code>, respectively.</p>
<p>To illustrate how these models are fitted, we simulate some longitudinal data from a hurdle negative binomial model using the code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">123</span>)
n &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co"># number of subjects</span>
K &lt;-<span class="st"> </span><span class="dv">8</span> <span class="co"># number of measurements per subject</span>
t_max &lt;-<span class="st"> </span><span class="dv">5</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we constuct a data frame with the design: </span>
<span class="co"># everyone has a baseline measurment, and then measurements at random follow-up times</span>
DF &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">rep</span>(<span class="kw">seq_len</span>(n), <span class="dt">each =</span> K),
                 <span class="dt">time =</span> <span class="kw">c</span>(<span class="kw">replicate</span>(n, <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">sort</span>(<span class="kw">runif</span>(K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">0</span>, t_max))))),
                 <span class="dt">sex =</span> <span class="kw">rep</span>(<span class="kw">gl</span>(<span class="dv">2</span>, n<span class="op">/</span><span class="dv">2</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"male"</span>, <span class="st">"female"</span>)), <span class="dt">each =</span> K))

<span class="co"># design matrices for the fixed and random effects non-zero part</span>
X &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">data =</span> DF)
Z &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>time, <span class="dt">data =</span> DF)
<span class="co"># design matrices for the fixed and random effects zero part</span>
X_zi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>sex, <span class="dt">data =</span> DF)
Z_zi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/methods.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> DF)

betas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.03</span>) <span class="co"># fixed effects coefficients non-zero part</span>
shape &lt;-<span class="st"> </span><span class="dv">2</span> <span class="co"># shape/size parameter of the negative binomial distribution</span>
gammas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span>) <span class="co"># fixed effects coefficients zero part</span>
D11 &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="co"># variance of random intercepts non-zero part</span>
D22 &lt;-<span class="st"> </span><span class="fl">0.1</span> <span class="co"># variance of random slopes non-zero part</span>
D33 &lt;-<span class="st"> </span><span class="fl">0.4</span> <span class="co"># variance of random intercepts zero part</span>

<span class="co"># we simulate random effects</span>
b &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D11)), <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D22)), <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="kw">sqrt</span>(D33)))
<span class="co"># linear predictor non-zero part</span>
eta_y &lt;-<span class="st"> </span><span class="kw">as.vector</span>(X <span class="op">%*%</span><span class="st"> </span>betas <span class="op">+</span><span class="st"> </span><span class="kw">rowSums</span>(Z <span class="op">*</span><span class="st"> </span>b[DF<span class="op">$</span>id, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>]))
<span class="co"># linear predictor zero part</span>
eta_zi &lt;-<span class="st"> </span><span class="kw">as.vector</span>(X_zi <span class="op">%*%</span><span class="st"> </span>gammas <span class="op">+</span><span class="st"> </span><span class="kw">rowSums</span>(Z_zi <span class="op">*</span><span class="st"> </span>b[DF<span class="op">$</span>id, <span class="dv">3</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>]))
<span class="co"># we simulate truncated at zero negative binomial longitudinal data</span>
lower &lt;-<span class="st"> </span><span class="kw">pnbinom</span>(<span class="dv">0</span>, <span class="dt">mu =</span> <span class="kw">exp</span>(eta_y), <span class="dt">size =</span> shape)
u &lt;-<span class="st"> </span><span class="kw">runif</span>(n <span class="op">*</span><span class="st"> </span>K, <span class="dt">min =</span> lower, <span class="dt">max =</span> <span class="dv">1</span>)
DF<span class="op">$</span>y &lt;-<span class="st"> </span><span class="kw">qnbinom</span>(u, <span class="dt">mu =</span> <span class="kw">exp</span>(eta_y), <span class="dt">size =</span> shape)
<span class="co"># we set the zeros from the logistic regression</span>
DF<span class="op">$</span>y[<span class="kw">as.logical</span>(<span class="kw">rbinom</span>(n <span class="op">*</span><span class="st"> </span>K, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="kw">plogis</span>(eta_zi)))] &lt;-<span class="st"> </span><span class="dv">0</span></code></pre></div>
<p>The following code fits a hurdle Poisson mixed effects model. In the fixed-effects part for the positive counts we include the main effects of <code>sex</code> and <code>time</code> and their interaction, and in the random-effects for the positive counts random intercepts and random slopes. For the zero-part we only include a fixed-effects part, using argument <code>zi_fixed</code>, with <code>sex</code> as the predictor:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dm1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixed_model.html">mixed_model</a></span>(y <span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span>time <span class="op">|</span><span class="st"> </span>id, <span class="dt">data =</span> DF, 
                  <span class="dt">family =</span> <span class="kw"><a href="../reference/extra_fams.html">hurdle.poisson</a></span>(), <span class="dt">zi_fixed =</span> <span class="op">~</span><span class="st"> </span>sex)

dm1
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span>
<span class="co">#&gt;     family = hurdle.poisson(), zi_fixed = ~sex)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: hurdle poisson</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;              StdDev    Corr</span>
<span class="co">#&gt; (Intercept)  0.8227        </span>
<span class="co">#&gt; time         0.3655 -0.3159</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;     1.52781877     0.08075223     0.09003660    -0.09189512 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.4178427   0.4857483 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -2802.3</span></code></pre></div>
<p>Currently, only the log-link is implemented for the <code><a href="../reference/extra_fams.html">hurdle.poisson()</a></code> family. The output is similar as in the case of the zero-inflated models. However, it has been noted that the fixed-effects coefficients for the positive counts part relate to the mean <span class="math inline">\(\mu\)</span> of Poisson distribution that includes the zeros, not the mean for those who experience the event. The mean for those who experience more than one events is <span class="math inline">\(\mu / (1 - e^{-\mu})\)</span>. Hence, a <span class="math inline">\(\beta = 0.1\)</span> cannot be interpreted as reflecting a <span class="math inline">\(e^\beta =\)</span> 10% increase in the mean of the subjects who experience the events.</p>
<p>We extend model <code>dm1</code> by also including a random intercept for the zero-part. As we have done above, this is achieved by specifying the <code>zi_random</code> argument, i.e.:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dm2 &lt;-<span class="st"> </span><span class="kw">update</span>(dm1, <span class="dt">zi_random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id)

dm2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span>
<span class="co">#&gt;     family = hurdle.poisson(), zi_fixed = ~sex, zi_random = ~1 | </span>
<span class="co">#&gt;         id)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: hurdle poisson</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                 StdDev    Corr        </span>
<span class="co">#&gt; (Intercept)     0.8226  (Intr)    time</span>
<span class="co">#&gt; time            0.3634 -0.3136        </span>
<span class="co">#&gt; zi_(Intercept)  0.6605 -0.0099  0.0724</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;     1.52753895     0.08367461     0.09194570    -0.08005393 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.5382756   0.5176922 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -2797.309</span></code></pre></div>
<p>The likelihood ratio test between the two models is computed with the <code><a href="../reference/methods.html">anova()</a></code> method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/methods.html">anova</a></span>(dm1, dm2)
<span class="co">#&gt; </span>
<span class="co">#&gt;         AIC     BIC  log.Lik  LRT df p.value</span>
<span class="co">#&gt; dm1 5622.60 5646.05 -2802.30                </span>
<span class="co">#&gt; dm2 5618.62 5618.62 -2797.31 9.98  3  0.0187</span></code></pre></div>
<p>The result indicates that the extra random effect for the zero-part improves the fit of the model.</p>
</div>
<div id="two-parthurdle-negative-binomial-mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#two-parthurdle-negative-binomial-mixed-effects-model" class="anchor"></a>Two-Part/Hurdle Negative Binomial Mixed Effects Model</h2>
<p>We continue our illustration of hurdle models by fitting the hurdle negative binomial mixed model. The only change from the previous syntax we used is the name of the family object, namely, we use now <code><a href="../reference/extra_fams.html">hurdle.negative.binomial()</a></code>. The code below fits exactly the same model as model <code>dm1</code> above, but using now the negative binomial distribution for the positive counts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hm1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixed_model.html">mixed_model</a></span>(y <span class="op">~</span><span class="st"> </span>sex <span class="op">*</span><span class="st"> </span>time, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span>time <span class="op">|</span><span class="st"> </span>id, <span class="dt">data =</span> DF, 
                  <span class="dt">family =</span> <span class="kw"><a href="../reference/extra_fams.html">hurdle.negative.binomial</a></span>(), <span class="dt">zi_fixed =</span> <span class="op">~</span><span class="st"> </span>sex)

hm1
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span>
<span class="co">#&gt;     family = hurdle.negative.binomial(), zi_fixed = ~sex)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: hurdle negative binomial</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;              StdDev    Corr</span>
<span class="co">#&gt; (Intercept)  0.7305        </span>
<span class="co">#&gt; time         0.3248 -0.1172</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;     1.48476535     0.07146542     0.10191941    -0.08920289 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;  -1.4178427   0.4857483 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  0.677947 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -2181.468</span></code></pre></div>
<p>Also for the <code><a href="../reference/extra_fams.html">hurdle.negative.binomial()</a></code> family only the log-link is implemented. The structure of the output is identical to what we had for the hurdle Poisson model. Again we should note that the fixed-effects coefficients for the positive part have an interpretation for the mean of the entire distribution, not only for the positive counts.</p>
<p>We update again the fitted model <code>hm1</code> by including a random intercept for the zero-part:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hm2 &lt;-<span class="st"> </span><span class="kw">update</span>(hm1, <span class="dt">zi_random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>id)

hm2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span>
<span class="co">#&gt;     family = hurdle.negative.binomial(), zi_fixed = ~sex, zi_random = ~1 | </span>
<span class="co">#&gt;         id)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model:</span>
<span class="co">#&gt;  family: hurdle negative binomial</span>
<span class="co">#&gt;  link: log </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects covariance matrix:</span>
<span class="co">#&gt;                 StdDev    Corr        </span>
<span class="co">#&gt; (Intercept)     0.7305  (Intr)    time</span>
<span class="co">#&gt; time            0.3243 -0.1140        </span>
<span class="co">#&gt; zi_(Intercept)  0.6648 -0.0520  0.1467</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span>
<span class="co">#&gt;     1.47815662     0.06708721     0.10517004    -0.08545594 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Zero-part coefficients:</span>
<span class="co">#&gt; (Intercept)   sexfemale </span>
<span class="co">#&gt;   -1.541591    0.519505 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; phi parameters:</span>
<span class="co">#&gt;  0.6774959 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; log-Lik: -2176.314</span></code></pre></div>
<p>The likelihood ratio test between the two models is computed with the <code><a href="../reference/methods.html">anova()</a></code> method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/methods.html">anova</a></span>(hm1, hm2)
<span class="co">#&gt; </span>
<span class="co">#&gt;         AIC     BIC  log.Lik   LRT df p.value</span>
<span class="co">#&gt; hm1 4382.94 4408.99 -2181.47                 </span>
<span class="co">#&gt; hm2 4378.63 4378.63 -2176.31 10.31  3  0.0161</span></code></pre></div>
<p>The result again indicates that the extra random effect for the zero-part improves the fit of the model.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#mixed-models-with-an-extra-zero-part">Mixed Models with an Extra Zero Part</a><ul class="nav nav-pills nav-stacked">
<li><a href="#zero-inflated-poisson-mixed-effects-model">Zero-Inflated Poisson Mixed Effects Model</a></li>
      <li><a href="#zero-inflated-negative-binomial-mixed-effects-model">Zero-Inflated Negative Binomial Mixed Effects Model</a></li>
      <li><a href="#two-part-mixed-effects-model-for-semi-continuous-data">Two-Part Mixed Effects Model for Semi-Continuous Data</a></li>
      <li><a href="#two-parthurdle-poisson-mixed-effects-model">Two-Part/Hurdle Poisson Mixed Effects Model</a></li>
      <li><a href="#two-parthurdle-negative-binomial-mixed-effects-model">Two-Part/Hurdle Negative Binomial Mixed Effects Model</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://www.drizopoulos.com/">Dimitris Rizopoulos</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
