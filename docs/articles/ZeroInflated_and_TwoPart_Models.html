<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zero-Inflated and Two-Part Mixed Effects Models â€¢ GLMMadaptive</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Zero-Inflated and Two-Part Mixed Effects Models">
<meta property="og:description" content="GLMMadaptive">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GLMMadaptive</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/GLMMadaptive.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Custom_Models.html">Custom Models</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/Goodness_of_Fit.html">Goodness of Fit for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Methods.html">Methods for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Multiple_Comparisons.html">Multiple Comparisons for MixMod Objects</a>
    </li>
    <li>
      <a href="../articles/Optimization.html">Optimization and Numerical Integration</a>
    </li>
    <li>
      <a href="../articles/Ordinal_Mixed_Models.html">Mixed Models for Ordinal Data</a>
    </li>
    <li>
      <a href="../articles/ZeroInflated_and_TwoPart_Models.html">Zero-Inflated and Two-Part Mixed Effects Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/GLMMadaptive/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Zero-Inflated and Two-Part Mixed Effects
Models</h1>
                        <h4 data-toc-skip class="author">Dimitris
Rizopoulos</h4>
            
            <h4 data-toc-skip class="date">2023-06-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/GLMMadaptive/blob/HEAD/vignettes/ZeroInflated_and_TwoPart_Models.Rmd" class="external-link"><code>vignettes/ZeroInflated_and_TwoPart_Models.Rmd</code></a></small>
      <div class="hidden name"><code>ZeroInflated_and_TwoPart_Models.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="mixed-models-with-an-extra-zero-part">Mixed Models with an Extra Zero Part<a class="anchor" aria-label="anchor" href="#mixed-models-with-an-extra-zero-part"></a>
</h2>
<p>Function <code><a href="../reference/mixed_model.html">mixed_model()</a></code> of <strong>GLMMadaptive</strong>
can also be used to fit zero-inflated and two-part mixed effects models.
For both types of models, a suitable <code>family</code> object needs to
be specified as outlined in
<code><a href="../articles/Custom_Models.html">vignette("Custom_Models", package = "GLMMadaptive")</a></code>, and
also arguments <code>zi_fixed</code> and <code>zi_random</code> of
<code><a href="../reference/mixed_model.html">mixed_model()</a></code> come into play. In these arguments, the user
can specify the fixed and random effects <code>formulas</code> of the
logistic regression for the zero-part of the distribution of the
outcome. We should note that the user has the option to leave
<code>zi_random</code> set to <code>NULL</code>, in which case for the
zero-part we have a logistic regression with only fixed effects and no
random effects.</p>
<p>In addition, in the specification of the <code>family</code> object,
and in order to better facilitate the internal computations, the user
may specify the function <code>score_eta_zi_fun</code> that calculates
the derivative of the log probability density function or the log
probability mass function with respect to <code>eta_zi</code> that
denotes the linear predictor of the logistic regression for the zero
part. Here we provide three examples to illustrate how such models can
be fitted.</p>
<div class="section level3">
<h3 id="zero-inflated-poisson-mixed-effects-model">Zero-Inflated Poisson Mixed Effects Model<a class="anchor" aria-label="anchor" href="#zero-inflated-poisson-mixed-effects-model"></a>
</h3>
<p>We start our illustrations by showing how we can fit a zero-inflated
Poisson mixed effects model. The specification of the required
<code>family</code> object is already available in the package as the
object returned by <code><a href="../reference/extra_fams.html">zi.poisson()</a></code>. <em>Currently, only the
log link is allowed.</em> First, we simulate longitudinal data from a
zero-inflated negative binomial distribution:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design: </span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random follow-up times</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects non-zero part</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="co"># design matrices for the fixed and random effects zero part</span></span>
<span><span class="va">X_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.03</span><span class="op">)</span> <span class="co"># fixed effects coefficients non-zero part</span></span>
<span><span class="va">shape</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># shape/size parameter of the negative binomial distribution</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="co"># fixed effects coefficients zero part</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random intercepts non-zero part</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.4</span> <span class="co"># variance of random intercepts zero part</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor non-zero part</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="fl">1</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor zero part</span></span>
<span><span class="va">eta_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_zi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_zi</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="fl">2</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we simulate negative binomial longitudinal data</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="va">shape</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we set the extra zeros</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>A zero-inflated Poisson mixed model with only fixed effects in the
zero part is fitted with the following call to
<code><a href="../reference/mixed_model.html">mixed_model()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                   family <span class="op">=</span> <span class="fu"><a href="../reference/extra_fams.html">zi.poisson</a></span><span class="op">(</span><span class="op">)</span>, zi_fixed <span class="op">=</span> <span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = zi.poisson(), zi_fixed = ~sex)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: zero-inflated poisson</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                StdDev</span></span>
<span><span class="co">#&gt; (Intercept) 0.8272898</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;   1.5275644687   0.0173647260  -0.0040365383   0.0004326841 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;   -1.210597    0.498611 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -2223.937</span></span></code></pre></div>
<p>As noted above, only the log link is currently available for the
non-zero part and the logit link for the zero part. Hence, the estimated
fixed effects for the two parts are interpreted accordingly. We extend
<code>fm1</code> by allowing also for random intercepts in the zero
part. We should note that by default the random intercept of the
non-zero part is correlated with the random intercept from the zero
part:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fm1</span>, zi_random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = zi.poisson(), zi_fixed = ~sex, zi_random = ~1 | </span></span>
<span><span class="co">#&gt;         id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: zero-inflated poisson</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                 StdDev    Corr</span></span>
<span><span class="co">#&gt; (Intercept)     0.7394        </span></span>
<span><span class="co">#&gt; zi_(Intercept)  0.6917 -0.6550</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;   1.5891884685  -0.0085650817  -0.0030156086   0.0002487272 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;   -1.112309    0.427672 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -2214.277</span></span></code></pre></div>
<p>We test if we need the extra random effect using a likelihood ratio
test:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/methods.html">anova</a></span><span class="op">(</span><span class="va">fm1</span>, <span class="va">fm2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         AIC     BIC  log.Lik   LRT df p.value</span></span>
<span><span class="co">#&gt; fm1 4461.87 4480.11 -2223.94                 </span></span>
<span><span class="co">#&gt; fm2 4446.55 4470.00 -2214.28 19.32  2   1e-04</span></span></code></pre></div>
<p>The results suggest that the extra random effect improves the fit of
the model.</p>
</div>
<div class="section level3">
<h3 id="zero-inflated-negative-binomial-mixed-effects-model">Zero-Inflated Negative Binomial Mixed Effects Model<a class="anchor" aria-label="anchor" href="#zero-inflated-negative-binomial-mixed-effects-model"></a>
</h3>
<p>We continue with the same data, but we now take into account the
potential over-dispersion in the data using a zero-inflated negative
binomial model. To fit this mixed model we use an almost identical
syntax to what we just did above - the only difference is that we now
specify as family the <code><a href="../reference/extra_fams.html">zi.negative.binomial()</a></code> object:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                   family <span class="op">=</span> <span class="fu"><a href="../reference/extra_fams.html">zi.negative.binomial</a></span><span class="op">(</span><span class="op">)</span>, zi_fixed <span class="op">=</span> <span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gm1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = zi.negative.binomial(), zi_fixed = ~sex)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: zero-inflated negative binomial</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                StdDev</span></span>
<span><span class="co">#&gt; (Intercept) 0.8293515</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;    1.467900626    0.029416703    0.003005305   -0.006440699 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.5554713   0.5914944 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; dispersion parameter:</span></span>
<span><span class="co">#&gt;  2.227075 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -1958.746</span></span></code></pre></div>
<p>Similarly to <code>fm1</code>, in <code>gm1</code> we specified only
fixed effects for the logistic regression for the zero part. We now
compare this model with the zero-inflated Poisson model that allowed for
a random intercept in the zero part. The comparison can be done with the
<code><a href="../reference/methods.html">anova()</a></code> method; because the two models are not nested, we
set <code>test = FALSE</code> in the call to <code><a href="../reference/methods.html">anova()</a></code>,
i.e.:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/methods.html">anova</a></span><span class="op">(</span><span class="va">gm1</span>, <span class="va">fm2</span>, test <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         AIC     BIC  log.Lik df</span></span>
<span><span class="co">#&gt; gm1 3933.49 3954.33 -1958.75   </span></span>
<span><span class="co">#&gt; fm2 4446.55 4470.00 -2214.28  1</span></span></code></pre></div>
<p>We observe that accounting for the over-dispersion seems to better
improve the fit than including the random intercepts term in the zero
part.</p>
</div>
<div class="section level3">
<h3 id="two-part-mixed-effects-model-for-semi-continuous-data">Two-Part Mixed Effects Model for Semi-Continuous Data<a class="anchor" aria-label="anchor" href="#two-part-mixed-effects-model-for-semi-continuous-data"></a>
</h3>
<p>To further illustrate the flexibility provided by
<strong>GLMMadaptive</strong> in allowing users to specify their own
family objects with a specific log density function, we consider the
setting of multivariate semi-continuous data. That is, continuous data
with excess zeros. In the literature the class of two-part / hurdle
mixed models has been proposed to analyze such data. These models
specify a logistic regression for the dichotomous indicator that the
outcome is zero or not, and a standard linear mixed model for the
logarithmic transformation of the non-zero responses.</p>
<p>We start again by simulating some longitudinal data from this
model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design: </span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random follow-up times</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects non-zero part</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="co"># design matrices for the fixed and random effects zero part</span></span>
<span><span class="va">X_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.13</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients non-zero part</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># standard deviation error terms non-zero part</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="co"># fixed effects coefficients zero part</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random intercepts non-zero part</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.1</span> <span class="co"># variance of random slopes non-zero part</span></span>
<span><span class="va">D33</span> <span class="op">&lt;-</span> <span class="fl">0.4</span> <span class="co"># variance of random intercepts zero part</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D33</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor non-zero part</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor zero part</span></span>
<span><span class="va">eta_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_zi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_zi</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="fl">3</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we simulate log-normal longitudinal data</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, mean <span class="op">=</span> <span class="va">eta_y</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we set the zeros from the logistic regression</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>To fit the two-part mixed model for log-normal data we can use the
already build-in <code><a href="../reference/extra_fams.html">hurdle.lognormal()</a></code> family object. However,
just as an illustration, and to show that users can define their own
family objects to be used in <code><a href="../reference/mixed_model.html">mixed_model()</a></code>, we explain how
exactly <code><a href="../reference/extra_fams.html">hurdle.lognormal()</a></code> is specified. To define the
family object: The minimal requirement is to specify the
<code>log_dens</code> component and the link function; however, as also
explained in the <a href="http://www.drizopoulos.com/vignettes/Custom_Models.html" class="external-link">Custom
Models</a> vignette, the internal calculations will be faster and more
stable if the user also specifies the score vector for the linear
predictor of the non-zero part (function <code>score_eta_fun()</code>),
the derivative of the log density with respect to <code>phis</code>
(function <code>score_phis_fun()</code>), and because we have a model
with a zero part, also the derivative of the log density with respect to
the linear predictor of the zero part (function
<code>score_eta_zi_fun()</code>). Finally, for being able to simulate
from the model using the <code><a href="../reference/methods.html">simulate()</a></code> method, the function
<code><a href="../reference/methods.html">simulate()</a></code> within the family object can also be specified.
Hence, the family object for the two-part model is defined as:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hurdle.lognormal</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/make.link.html" class="external-link">make.link</a></span><span class="op">(</span><span class="st">"identity"</span><span class="op">)</span></span>
<span>    <span class="va">log_dens</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">y</span>, <span class="va">eta</span>, <span class="va">mu_fun</span>, <span class="va">phis</span>, <span class="va">eta_zi</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">phis</span><span class="op">)</span></span>
<span>        <span class="co"># binary indicator for y &gt; 0</span></span>
<span>        <span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>        <span class="co"># non-zero part</span></span>
<span>        <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span></span>
<span>        <span class="va">eta_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">)</span></span>
<span>        <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">eta</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span>, log.p <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span>, mean <span class="op">=</span> <span class="va">eta</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span>, sd <span class="op">=</span> <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="co"># zero part</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">[</span><span class="op">!</span><span class="va">ind</span>, <span class="op">]</span>, log.p <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">out</span>, <span class="st">"mu_y"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">eta</span></span>
<span>        <span class="va">out</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">score_eta_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">y</span>, <span class="va">mu</span>, <span class="va">phis</span>, <span class="va">eta_zi</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">phis</span><span class="op">)</span></span>
<span>        <span class="co"># binary indicator for y &gt; 0</span></span>
<span>        <span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>        <span class="co"># non-zero part</span></span>
<span>        <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span></span>
<span>        <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">eta</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="va">eta</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">sigma</span><span class="op">^</span><span class="fl">2</span></span>
<span>        <span class="va">out</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">score_eta_zi_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">y</span>, <span class="va">mu</span>, <span class="va">phis</span>, <span class="va">eta_zi</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>        <span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">out</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">probs</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="va">probs</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span></span>
<span>        <span class="va">out</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">score_phis_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">y</span>, <span class="va">mu</span>, <span class="va">phis</span>, <span class="va">eta_zi</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">phis</span><span class="op">)</span></span>
<span>        <span class="co"># binary indicator for y &gt; 0</span></span>
<span>        <span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>        <span class="co"># non-zero part</span></span>
<span>        <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span></span>
<span>        <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">eta</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">out</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="va">eta</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">sigma</span><span class="op">^</span><span class="fl">2</span></span>
<span>        <span class="va">out</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">simulate</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">phis</span>, <span class="va">eta_zi</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, meanlog <span class="op">=</span> <span class="va">mu</span>, sdlog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">phis</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">y</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"two-part log-normal"</span>, link <span class="op">=</span> <span class="va">stats</span><span class="op">$</span><span class="va">name</span>, </span>
<span>                   linkfun <span class="op">=</span> <span class="va">stats</span><span class="op">$</span><span class="va">linkfun</span>, linkinv <span class="op">=</span> <span class="va">stats</span><span class="op">$</span><span class="va">linkinv</span>, log_dens <span class="op">=</span> <span class="va">log_dens</span>,</span>
<span>                   score_eta_fun <span class="op">=</span> <span class="va">score_eta_fun</span>, score_eta_zi_fun <span class="op">=</span> <span class="va">score_eta_zi_fun</span>,</span>
<span>                   score_phis_fun <span class="op">=</span> <span class="va">score_phis_fun</span>, simulate <span class="op">=</span> <span class="va">simulate</span><span class="op">)</span>,</span>
<span>              class <span class="op">=</span> <span class="st">"family"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then to fit the model, we provide the user-defined family object in
the <code>family</code> argument of <code><a href="../reference/mixed_model.html">mixed_model()</a></code>,
specifying also that we have one dispersion parameter in the family
(i.e., <code>n_phis = 1</code>), and that in the zero part we only
include fixed effects:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">km1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>, </span>
<span>                  family <span class="op">=</span> <span class="fu"><a href="../reference/extra_fams.html">hurdle.lognormal</a></span><span class="op">(</span><span class="op">)</span>, n_phis <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  zi_fixed <span class="op">=</span> <span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">km1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = hurdle.lognormal(), zi_fixed = ~sex, n_phis = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: two-part log-normal</span></span>
<span><span class="co">#&gt;  link: identity </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                StdDev</span></span>
<span><span class="co">#&gt; (Intercept) 0.9609426</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;    -2.08122468    -0.24046281     0.22303981    -0.05686286 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.6034499   0.6713555 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; phi parameters:</span></span>
<span><span class="co">#&gt;  -0.3348787 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -1214.208</span></span></code></pre></div>
<p>The estimated standard deviation for the error terms is
<code>exp(phis) =</code> 0.7 We extend the model by allowing for a
random intercept in the zero-part, but using the <code>||</code> symbol
in the <code>random</code> argument we specify the covariance matrix of
the random effects is diagonal; hence, that the two random intercepts
terms are uncorrelated:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">km2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">km1</span>, random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">||</span> <span class="va">id</span>, zi_random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">km2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~1 || id, data = DF, </span></span>
<span><span class="co">#&gt;     family = hurdle.lognormal(), zi_fixed = ~sex, zi_random = ~1 | </span></span>
<span><span class="co">#&gt;         id, n_phis = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: two-part log-normal</span></span>
<span><span class="co">#&gt;  link: identity </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                StdDev</span></span>
<span><span class="co">#&gt; (Intercept)    0.9609</span></span>
<span><span class="co">#&gt; zi_(Intercept) 0.6043</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;     -2.0811898     -0.2405682      0.2230215     -0.0568855 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.7160430   0.7096562 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; phi parameters:</span></span>
<span><span class="co">#&gt;  -0.3349759 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -1210.313</span></span></code></pre></div>
<p>For zero-inflated or hurdle models the <code><a href="../reference/marginal_coefs.html">marginal_coefs()</a></code>
functions provides the marginalized coefficients corresponding the
average mixture response variable, i.e., <span class="math display">\[(1
- \pi) \times E(Y),\]</span> where <span class="math inline">\(\pi\)</span> denotes the probability of being
zero, and <span class="math inline">\(Y\)</span> the response random
variable for the non-zero part. For example, in the case of the hurdle
log-normal family, we get the marginalized coefficients for <span class="math inline">\((1 - \pi) \times E\{\log(Y)\}\)</span>, e.g.,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/marginal_coefs.html">marginal_coefs</a></span><span class="op">(</span><span class="va">km2</span><span class="op">)</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;        -1.7311         0.0626         0.1852        -0.0661</span></span></code></pre></div>
<p>Finally, we show how the <code><a href="../reference/methods.html">simulate()</a></code> method can be used
to perform a replication / posterior predictive check. In particular, in
the following code we compare the empirical distribution function
estimated in the observed data with estimates of the empirical
distribution function obtained from simulated/replicated data from the
model. In the call to <code><a href="../reference/methods.html">simulate()</a></code> below we also specify to
account for the variability in the maximum likelihood estimates by
setting <code>acount_MLEs_var = TRUE</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">2.5</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, mgp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>, <span class="fl">0.5</span>, <span class="fl">0</span><span class="op">)</span>, cex.axis <span class="op">=</span> <span class="fl">0.7</span>, cex.lab <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">y</span><span class="op">[</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">x_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">simulate</a></span><span class="op">(</span><span class="va">km2</span>, nsim <span class="op">=</span> <span class="fl">30</span>, acount_MLEs_var <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">out</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span></span>
<span><span class="va">out</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rep_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">2</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">x_vals</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/ecdf.html" class="external-link">ecdf</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">(</span><span class="va">x_vals</span><span class="op">)</span>, x_vals <span class="op">=</span> <span class="va">x_vals</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">x_vals</span>, <span class="va">rep_y</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"lightgrey"</span>, </span>
<span>        xlab <span class="op">=</span> <span class="st">"Response Variable"</span>, ylab <span class="op">=</span> <span class="st">"Empirical CDF"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x_vals</span>, <span class="fu"><a href="https://rdrr.io/r/stats/ecdf.html" class="external-link">ecdf</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">(</span><span class="va">x_vals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"log replicated data"</span>, <span class="st">"log observed data"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lightgrey"</span>, <span class="st">"black"</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="ZeroInflated_and_TwoPart_Models_files/figure-html/unnamed-chunk-12-1.png" width="816" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="two-parthurdle-poisson-mixed-effects-model">Two-Part/Hurdle Poisson Mixed Effects Model<a class="anchor" aria-label="anchor" href="#two-parthurdle-poisson-mixed-effects-model"></a>
</h3>
<p>An alternative modeling framework to account for high percentages of
0 in count data is hurdle models. These models are similar to the
two-part model for semi-continuous data presented above. The difference
is that for the positive part we have positive counts instead of a
positive continuous outcome. For the positive counts, a truncated at
zero Poisson or negative binomial distribution is typically used. Both
hurdle Poisson and hurdle negative binomial mixed models can be fitted
by <code><a href="../reference/mixed_model.html">mixed_model()</a></code> using the family objects
<code><a href="../reference/extra_fams.html">hurdle.poisson()</a></code> and <code>hurdle.negative.binomial</code>,
respectively.</p>
<p>To illustrate how these models are fitted, we simulate some
longitudinal data from a hurdle negative binomial model using the
code:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design: </span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random follow-up times</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects non-zero part</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="co"># design matrices for the fixed and random effects zero part</span></span>
<span><span class="va">X_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.03</span><span class="op">)</span> <span class="co"># fixed effects coefficients non-zero part</span></span>
<span><span class="va">shape</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># shape/size parameter of the negative binomial distribution</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="co"># fixed effects coefficients zero part</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random intercepts non-zero part</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.1</span> <span class="co"># variance of random slopes non-zero part</span></span>
<span><span class="va">D33</span> <span class="op">&lt;-</span> <span class="fl">0.4</span> <span class="co"># variance of random intercepts zero part</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D33</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor non-zero part</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor zero part</span></span>
<span><span class="va">eta_zi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_zi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_zi</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="fl">3</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we simulate truncated at zero negative binomial longitudinal data</span></span>
<span><span class="va">lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">pnbinom</a></span><span class="op">(</span><span class="fl">0</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">shape</span><span class="op">)</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, min <span class="op">=</span> <span class="va">lower</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">qnbinom</a></span><span class="op">(</span><span class="va">u</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">shape</span><span class="op">)</span></span>
<span><span class="co"># we set the zeros from the logistic regression</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_zi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>The following code fits a hurdle Poisson mixed effects model. In the
fixed-effects part for the positive counts we include the main effects
of <code>sex</code> and <code>time</code> and their interaction, and in
the random-effects for the positive counts random intercepts and random
slopes. For the zero-part we only include a fixed-effects part, using
argument <code>zi_fixed</code>, with <code>sex</code> as the
predictor:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>, </span>
<span>                  family <span class="op">=</span> <span class="fu"><a href="../reference/extra_fams.html">hurdle.poisson</a></span><span class="op">(</span><span class="op">)</span>, zi_fixed <span class="op">=</span> <span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dm1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = hurdle.poisson(), zi_fixed = ~sex)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: hurdle poisson</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;              StdDev    Corr</span></span>
<span><span class="co">#&gt; (Intercept)  0.8231        </span></span>
<span><span class="co">#&gt; time         0.3649 -0.3136</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;     1.52797499     0.08041345     0.08988228    -0.09127713 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.4178427   0.4857483 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -2802.3</span></span></code></pre></div>
<p>Currently, only the log-link is implemented for the
<code><a href="../reference/extra_fams.html">hurdle.poisson()</a></code> family. The output is similar as in the
case of the zero-inflated models. However, it has been noted that the
fixed-effects coefficients for the positive counts part relate to the
mean <span class="math inline">\(\mu\)</span> of Poisson distribution
that includes the zeros, not the mean for those who experience the
event. The mean for those who experience more than one events is <span class="math inline">\(\mu / (1 - e^{-\mu})\)</span>. Hence, a <span class="math inline">\(\beta = 0.1\)</span> cannot be interpreted as
reflecting a <span class="math inline">\(e^\beta =\)</span> 10% increase
in the mean of the subjects who experience the events.</p>
<p>We extend model <code>dm1</code> by also including a random intercept
for the zero-part. As we have done above, this is achieved by specifying
the <code>zi_random</code> argument, i.e.:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">dm1</span>, zi_random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dm2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = hurdle.poisson(), zi_fixed = ~sex, zi_random = ~1 | </span></span>
<span><span class="co">#&gt;         id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: hurdle poisson</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                 StdDev    Corr        </span></span>
<span><span class="co">#&gt; (Intercept)     0.8226  (Intr)    time</span></span>
<span><span class="co">#&gt; time            0.3644 -0.3125        </span></span>
<span><span class="co">#&gt; zi_(Intercept)  0.6584 -0.0065  0.0636</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;     1.52792269     0.08389745     0.09206185    -0.08020395 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.5398382   0.5175922 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -2797.307</span></span></code></pre></div>
<p>The likelihood ratio test between the two models is computed with the
<code><a href="../reference/methods.html">anova()</a></code> method:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/methods.html">anova</a></span><span class="op">(</span><span class="va">dm1</span>, <span class="va">dm2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         AIC     BIC  log.Lik  LRT df p.value</span></span>
<span><span class="co">#&gt; dm1 5622.60 5646.05 -2802.30                </span></span>
<span><span class="co">#&gt; dm2 5618.61 5649.88 -2797.31 9.99  3  0.0187</span></span></code></pre></div>
<p>The result indicates that the extra random effect for the zero-part
improves the fit of the model.</p>
</div>
<div class="section level3">
<h3 id="two-parthurdle-negative-binomial-mixed-effects-model">Two-Part/Hurdle Negative Binomial Mixed Effects Model<a class="anchor" aria-label="anchor" href="#two-parthurdle-negative-binomial-mixed-effects-model"></a>
</h3>
<p>We continue our illustration of hurdle models by fitting the hurdle
negative binomial mixed model. The only change from the previous syntax
we used is the name of the family object, namely, we use now
<code><a href="../reference/extra_fams.html">hurdle.negative.binomial()</a></code>. The code below fits exactly the
same model as model <code>dm1</code> above, but using now the negative
binomial distribution for the positive counts:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mixed_model.html">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>, </span>
<span>                  family <span class="op">=</span> <span class="fu"><a href="../reference/extra_fams.html">hurdle.negative.binomial</a></span><span class="op">(</span><span class="op">)</span>, zi_fixed <span class="op">=</span> <span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hm1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = hurdle.negative.binomial(), zi_fixed = ~sex)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: hurdle negative binomial</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;              StdDev    Corr</span></span>
<span><span class="co">#&gt; (Intercept)  0.7305        </span></span>
<span><span class="co">#&gt; time         0.3249 -0.1170</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;     1.48250218     0.07508276     0.10249953    -0.08978082 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.4178427   0.4857483 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; phi parameters:</span></span>
<span><span class="co">#&gt;  0.6778918 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -2181.468</span></span></code></pre></div>
<p>Also for the <code><a href="../reference/extra_fams.html">hurdle.negative.binomial()</a></code> family only the
log-link is implemented. The structure of the output is identical to
what we had for the hurdle Poisson model. Again we should note that the
fixed-effects coefficients for the positive part have an interpretation
for the mean of the entire distribution, not only for the positive
counts.</p>
<p>We update again the fitted model <code>hm1</code> by including a
random intercept for the zero-part:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">hm1</span>, zi_random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hm2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; mixed_model(fixed = y ~ sex * time, random = ~time | id, data = DF, </span></span>
<span><span class="co">#&gt;     family = hurdle.negative.binomial(), zi_fixed = ~sex, zi_random = ~1 | </span></span>
<span><span class="co">#&gt;         id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;  family: hurdle negative binomial</span></span>
<span><span class="co">#&gt;  link: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects covariance matrix:</span></span>
<span><span class="co">#&gt;                 StdDev    Corr        </span></span>
<span><span class="co">#&gt; (Intercept)     0.7315  (Intr)    time</span></span>
<span><span class="co">#&gt; time            0.3258 -0.1155        </span></span>
<span><span class="co">#&gt; zi_(Intercept)  0.6598 -0.0517  0.1412</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;    (Intercept)      sexfemale           time sexfemale:time </span></span>
<span><span class="co">#&gt;     1.47627667     0.07040678     0.10535938    -0.08613120 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Zero-part coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)   sexfemale </span></span>
<span><span class="co">#&gt;  -1.5420047   0.5197229 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; phi parameters:</span></span>
<span><span class="co">#&gt;  0.6759598 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log-Lik: -2176.312</span></span></code></pre></div>
<p>The likelihood ratio test between the two models is computed with the
<code><a href="../reference/methods.html">anova()</a></code> method:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/methods.html">anova</a></span><span class="op">(</span><span class="va">hm1</span>, <span class="va">hm2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         AIC     BIC  log.Lik   LRT df p.value</span></span>
<span><span class="co">#&gt; hm1 4382.94 4408.99 -2181.47                 </span></span>
<span><span class="co">#&gt; hm2 4378.62 4412.49 -2176.31 10.31  3  0.0161</span></span></code></pre></div>
<p>The result again indicates that the extra random effect for the
zero-part improves the fit of the model.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
